var T=Object.defineProperty;var $=(l,s,r)=>s in l?T(l,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):l[s]=r;var h=(l,s,r)=>$(l,typeof s!="symbol"?s+"":s,r);import{r as x,j as e}from"./index-C7SuDyTR.js";import{C as k}from"./ComponentTemplate-BzrYXZsv.js";let I=class{static generateKey(s,r){const n=this.sortObject(s),a=JSON.stringify({endpoint:r,data:n});return this.hashString(a)}static generateClientKey(){const s=Date.now(),r=Math.random().toString(36).substring(2);return`client_${s}_${r}`}static sortObject(s){if(s===null||typeof s!="object")return s;if(Array.isArray(s))return s.map(a=>this.sortObject(a));const r=Object.keys(s).sort(),n={};for(const a of r)n[a]=this.sortObject(s[a]);return n}static hashString(s){let r=0;for(let n=0;n<s.length;n++){const a=s.charCodeAt(n);r=(r<<5)-r+a,r=r&r}return Math.abs(r).toString(36)}},O=class{constructor(s=1e3,r=5*60*1e3){h(this,"cache",new Map);h(this,"maxCacheSize");h(this,"ttl");this.maxCacheSize=s,this.ttl=r}isProcessed(s){const r=this.cache.get(s);return r?Date.now()-r.timestamp>this.ttl?(this.cache.delete(s),!1):!0:!1}getResult(s){const r=this.cache.get(s);return r?r.result:null}storeResult(s,r){if(this.cache.size>=this.maxCacheSize){const n=this.cache.keys().next().value;n!==void 0&&this.cache.delete(n)}this.cache.set(s,{result:r,timestamp:Date.now()})}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,maxSize:this.maxCacheSize}}};var D;let w=(D=class{static async processPayment(s){if(this.requestCount++,await new Promise(r=>setTimeout(r,1e3)),Math.random()<.1)throw new Error("支付处理失败");return{success:!0,transactionId:`txn_${Date.now()}_${Math.random().toString(36).substring(2)}`,amount:s.amount,timestamp:new Date().toISOString(),requestNumber:this.requestCount}}static async createOrder(s){if(this.requestCount++,await new Promise(r=>setTimeout(r,800)),Math.random()<.05)throw new Error("订单创建失败");return{success:!0,orderId:`order_${Date.now()}_${Math.random().toString(36).substring(2)}`,items:s.items,total:s.total,timestamp:new Date().toISOString(),requestNumber:this.requestCount}}static getRequestCount(){return this.requestCount}static resetRequestCount(){this.requestCount=0}},h(D,"requestCount",0),D);const q=()=>{const[l]=x.useState(()=>new O),[s,r]=x.useState({amount:100,currency:"USD",userId:"user123"}),[n,a]=x.useState({items:[{id:"1",name:"商品A",price:50,quantity:2},{id:"2",name:"商品B",price:30,quantity:1}],total:130,userId:"user123"}),[u,p]=x.useState([]),[g,y]=x.useState({}),f=async()=>{const o=I.generateKey(s,"/api/payment");y(c=>({...c,payment:!0}));try{let c,d=!1;l.isProcessed(o)?(c=l.getResult(o),d=!0):(c=await w.processPayment(s),l.storeResult(o,c));const m={id:`log_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"payment",data:s,result:c,timestamp:new Date().toISOString(),idempotencyKey:o,fromCache:d};p(b=>[m,...b])}catch(c){const d={id:`log_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"payment",data:s,result:null,timestamp:new Date().toISOString(),idempotencyKey:o,fromCache:!1,error:c instanceof Error?c.message:"未知错误"};p(m=>[d,...m])}finally{y(c=>({...c,payment:!1}))}},j=async()=>{const o=I.generateKey(n,"/api/order");y(c=>({...c,order:!0}));try{let c,d=!1;l.isProcessed(o)?(c=l.getResult(o),d=!0):(c=await w.createOrder(n),l.storeResult(o,c));const m={id:`log_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"order",data:n,result:c,timestamp:new Date().toISOString(),idempotencyKey:o,fromCache:d};p(b=>[m,...b])}catch(c){const d={id:`log_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"order",data:n,result:null,timestamp:new Date().toISOString(),idempotencyKey:o,fromCache:!1,error:c instanceof Error?c.message:"未知错误"};p(m=>[d,...m])}finally{y(c=>({...c,order:!1}))}},v=()=>{l.clearCache(),p([]),w.resetRequestCount()},i=l.getCacheStats();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"幂等性请求控制面板"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"支付请求"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"金额"}),e.jsx("input",{type:"number",value:s.amount,onChange:t=>r(o=>({...o,amount:Number(t.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"货币"}),e.jsxs("select",{value:s.currency,onChange:t=>r(o=>({...o,currency:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"CNY",children:"CNY"})]})]}),e.jsx("button",{onClick:f,disabled:g.payment,className:"w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed",children:g.payment?"处理中...":"执行支付"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"订单请求"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"订单总额"}),e.jsx("input",{type:"number",value:n.total,onChange:t=>a(o=>({...o,total:Number(t.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"商品数量"}),e.jsx("input",{type:"number",value:n.items.length,onChange:t=>{const o=Number(t.target.value),c=Array.from({length:o},(d,m)=>({id:`${m+1}`,name:`商品${String.fromCharCode(65+m)}`,price:50+m*10,quantity:1}));a(d=>({...d,items:c}))},min:"1",max:"5",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("button",{onClick:j,disabled:g.order,className:"w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed",children:g.order?"处理中...":"创建订单"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"缓存使用情况"}),e.jsxs("div",{className:"text-lg font-semibold",children:[i.size," / ",i.maxSize]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"总请求次数"}),e.jsx("div",{className:"text-lg font-semibold",children:w.getRequestCount()})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"请求日志"}),e.jsx("div",{className:"text-lg font-semibold",children:u.length})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{onClick:v,className:"bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600",children:"清空缓存和日志"})})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"请求日志"}),u.length===0?e.jsx("div",{className:"text-gray-500 text-center py-8",children:"暂无请求日志"}):e.jsx("div",{className:"space-y-4",children:u.map(t=>e.jsxs("div",{className:`p-4 rounded-lg border-l-4 ${t.error?"border-red-500 bg-red-50":t.fromCache?"border-yellow-500 bg-yellow-50":"border-green-500 bg-green-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.type==="payment"?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:t.type==="payment"?"支付":"订单"}),t.fromCache&&e.jsx("span",{className:"px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800",children:"来自缓存"}),t.error&&e.jsx("span",{className:"px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800",children:"错误"})]}),e.jsx("div",{className:"text-sm text-gray-500",children:new Date(t.timestamp).toLocaleTimeString()})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-700 mb-1",children:"幂等性密钥"}),e.jsx("div",{className:"font-mono text-xs bg-gray-100 p-2 rounded break-all",children:t.idempotencyKey})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-700 mb-1",children:t.error?"错误信息":"响应结果"}),e.jsx("div",{className:"font-mono text-xs bg-gray-100 p-2 rounded",children:t.error?t.error:JSON.stringify(t.result,null,2)})]})]})]},t.id))})]})]})};let _=class{static generateKey(s,r){const n=this.sortObject(s),a=JSON.stringify({endpoint:r,data:n});return this.hashString(a)}static generateClientKey(){const s=Date.now(),r=Math.random().toString(36).substring(2);return`client_${s}_${r}`}static sortObject(s){if(s===null||typeof s!="object")return s;if(Array.isArray(s))return s.map(a=>this.sortObject(a));const r=Object.keys(s).sort(),n={};for(const a of r)n[a]=this.sortObject(s[a]);return n}static hashString(s){let r=0;for(let n=0;n<s.length;n++){const a=s.charCodeAt(n);r=(r<<5)-r+a,r=r&r}return Math.abs(r).toString(36)}};class K{constructor(s=1e3,r=5*60*1e3){h(this,"cache",new Map);h(this,"maxCacheSize");h(this,"ttl");this.maxCacheSize=s,this.ttl=r}isProcessed(s){const r=this.cache.get(s);return r?Date.now()-r.timestamp>this.ttl?(this.cache.delete(s),!1):!0:!1}getResult(s){const r=this.cache.get(s);return r?r.result:null}storeResult(s,r){if(this.cache.size>=this.maxCacheSize){const n=this.cache.keys().next().value;n!==void 0&&this.cache.delete(n)}this.cache.set(s,{result:r,timestamp:Date.now()})}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,maxSize:this.maxCacheSize}}}class C{static async processTransfer(s){const r=`transfer_${Date.now()}_${Math.random().toString(36).substring(2)}`,n=JSON.stringify(s);if(this.processingRequests.has(n))throw new Error("相同的转账请求正在处理中");this.processingRequests.add(n),this.requestCount++;try{if(await new Promise(a=>setTimeout(a,2e3+Math.random()*1e3)),Math.random()<.15)throw new Error("转账处理失败");return{success:!0,transferId:r,from:s.from,to:s.to,amount:s.amount,timestamp:new Date().toISOString(),requestNumber:this.requestCount}}finally{this.processingRequests.delete(n)}}static getRequestCount(){return this.requestCount}static resetRequestCount(){this.requestCount=0,this.processingRequests.clear()}static getProcessingCount(){return this.processingRequests.size}}h(C,"requestCount",0),h(C,"processingRequests",new Set);const P=()=>{const[l]=x.useState(()=>new K),[s,r]=x.useState({from:"account_001",to:"account_002",amount:1e3,description:"转账测试"}),[n,a]=x.useState([]),[u,p]=x.useState(3),[g,y]=x.useState(!1),f=async t=>{const c=_.generateKey(t.transferData,"/api/transfer");a(d=>d.map(m=>m.id===t.id?{...m,status:"processing",idempotencyKey:c}:m));try{let d,m=!1;l.isProcessed(c)?(d=l.getResult(c),m=!0):(d=await C.processTransfer(t.transferData),l.storeResult(c,d)),a(b=>b.map(S=>S.id===t.id?{...S,status:"success",result:d,endTime:Date.now(),fromCache:m}:S))}catch(d){a(m=>m.map(b=>b.id===t.id?{...b,status:"error",error:d instanceof Error?d.message:"未知错误",endTime:Date.now(),fromCache:!1}:b))}},j=async()=>{if(g)return;y(!0);const t=Array.from({length:u},(c,d)=>({id:`test_${Date.now()}_${d}`,transferData:{...s},idempotencyKey:"",status:"pending",startTime:Date.now(),fromCache:!1}));a(t);const o=t.map(c=>f(c));try{await Promise.all(o)}catch(c){console.error("并发测试出错:",c)}finally{y(!1)}},v=()=>{a([]),l.clearCache(),C.resetRequestCount()},i={total:n.length,success:n.filter(t=>t.status==="success").length,error:n.filter(t=>t.status==="error").length,processing:n.filter(t=>t.status==="processing").length,fromCache:n.filter(t=>t.fromCache).length,avgDuration:n.filter(t=>t.endTime).reduce((t,o)=>t+(o.endTime-o.startTime),0)/Math.max(1,n.filter(t=>t.endTime).length)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"并发请求测试控制面板"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"转账数据配置"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"转出账户"}),e.jsx("input",{type:"text",value:s.from,onChange:t=>r(o=>({...o,from:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"转入账户"}),e.jsx("input",{type:"text",value:s.to,onChange:t=>r(o=>({...o,to:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"转账金额"}),e.jsx("input",{type:"number",value:s.amount,onChange:t=>r(o=>({...o,amount:Number(t.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"转账描述"}),e.jsx("input",{type:"text",value:s.description,onChange:t=>r(o=>({...o,description:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"并发测试配置"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"并发请求数量"}),e.jsx("input",{type:"number",value:u,onChange:t=>p(Number(t.target.value)),min:"2",max:"10",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:j,disabled:g,className:"w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed",children:g?"测试进行中...":"开始并发测试"}),e.jsx("button",{onClick:v,disabled:g,className:"w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed",children:"清空测试结果"})]})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"总请求数"}),e.jsx("div",{className:"text-lg font-semibold",children:i.total})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"成功请求"}),e.jsx("div",{className:"text-lg font-semibold text-green-600",children:i.success})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"缓存命中"}),e.jsx("div",{className:"text-lg font-semibold text-yellow-600",children:i.fromCache})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"平均耗时"}),e.jsx("div",{className:"text-lg font-semibold text-blue-600",children:i.avgDuration>0?`${Math.round(i.avgDuration)}ms`:"-"})]})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"并发测试结果"}),n.length===0?e.jsx("div",{className:"text-gray-500 text-center py-8",children:'点击"开始并发测试"来测试幂等性处理'}):e.jsx("div",{className:"space-y-4",children:n.map((t,o)=>e.jsxs("div",{className:`p-4 rounded-lg border-l-4 ${t.status==="success"?t.fromCache?"border-yellow-500 bg-yellow-50":"border-green-500 bg-green-50":t.status==="error"?"border-red-500 bg-red-50":t.status==="processing"?"border-blue-500 bg-blue-50":"border-gray-500 bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800",children:["请求 #",o+1]}),e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${t.status==="success"?"bg-green-100 text-green-800":t.status==="error"?"bg-red-100 text-red-800":t.status==="processing"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:t.status==="success"?"成功":t.status==="error"?"失败":t.status==="processing"?"处理中":"等待"}),t.fromCache&&e.jsx("span",{className:"px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800",children:"来自缓存"})]}),e.jsx("div",{className:"text-sm text-gray-500",children:t.endTime?`${t.endTime-t.startTime}ms`:"进行中..."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-700 mb-1",children:"幂等性密钥"}),e.jsx("div",{className:"font-mono text-xs bg-gray-100 p-2 rounded break-all",children:t.idempotencyKey||"生成中..."})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-700 mb-1",children:t.error?"错误信息":"响应结果"}),e.jsx("div",{className:"font-mono text-xs bg-gray-100 p-2 rounded",children:t.error?t.error:t.result?JSON.stringify(t.result,null,2):"等待响应..."})]})]})]},t.id))})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"测试说明"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• 此演示模拟多个相同的转账请求同时发送的场景"}),e.jsx("li",{children:"• 通过幂等性机制，只有第一个请求会被实际处理"}),e.jsx("li",{children:"• 后续相同的请求会直接返回缓存的结果"}),e.jsx("li",{children:'• 观察"来自缓存"标签来验证幂等性的效果'}),e.jsx("li",{children:"• 修改转账数据后重新测试会生成不同的幂等性密钥"})]})]})]})};class N{static generateKey(s,r){const n=this.sortObject(s),a=JSON.stringify({endpoint:r,data:n});return this.hashString(a)}static generateClientKey(){const s=Date.now(),r=Math.random().toString(36).substring(2);return`client_${s}_${r}`}static sortObject(s){if(s===null||typeof s!="object")return s;if(Array.isArray(s))return s.map(a=>this.sortObject(a));const r=Object.keys(s).sort(),n={};for(const a of r)n[a]=this.sortObject(s[a]);return n}static hashString(s){let r=0;for(let n=0;n<s.length;n++){const a=s.charCodeAt(n);r=(r<<5)-r+a,r=r&r}return Math.abs(r).toString(36)}static generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){const r=Math.random()*16|0;return(s==="x"?r:r&3|8).toString(16)})}static generateTimestampKey(s="req"){const r=Date.now(),n=Math.random().toString(36).substring(2,8);return`${s}_${r}_${n}`}static generateUserOperationKey(s,r,n){const a=this.sortObject(n),u=JSON.stringify({userId:s,operation:r,data:a});return`${s}_${r}_${this.hashString(u)}`}}const U=()=>{const[l,s]=x.useState([]),[r,n]=x.useState({endpoint:"/api/payment",amount:100,currency:"USD",userId:"user123",description:"支付订单"}),[a,u]=x.useState({userId:"user123",operation:"transfer",from:"account_001",to:"account_002",amount:500}),p=()=>{const i=N.generateKey({amount:r.amount,currency:r.currency,userId:r.userId,description:r.description},r.endpoint),t={id:`example_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"内容哈希密钥",description:"基于请求内容生成的确定性密钥，相同内容总是生成相同密钥",input:{endpoint:r.endpoint,data:{amount:r.amount,currency:r.currency,userId:r.userId,description:r.description}},key:i,timestamp:new Date().toISOString()};s(o=>[t,...o])},g=()=>{const i=N.generateClientKey(),t={id:`example_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"客户端唯一密钥",description:"基于时间戳和随机数生成的唯一密钥，每次都不同",input:{timestamp:Date.now(),random:"随机生成"},key:i,timestamp:new Date().toISOString()};s(o=>[t,...o])},y=()=>{const i=N.generateUUID(),t={id:`example_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"UUID密钥",description:"标准UUID v4格式的唯一标识符",input:{format:"UUID v4",pattern:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"},key:i,timestamp:new Date().toISOString()};s(o=>[t,...o])},f=()=>{const i=N.generateTimestampKey("payment"),t={id:`example_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"时间戳密钥",description:"基于时间戳和前缀生成的密钥，包含时间信息",input:{prefix:"payment",timestamp:Date.now(),format:"prefix_timestamp_random"},key:i,timestamp:new Date().toISOString()};s(o=>[t,...o])},j=()=>{const i=N.generateUserOperationKey(a.userId,a.operation,{from:a.from,to:a.to,amount:a.amount}),t={id:`example_${Date.now()}_${Math.random().toString(36).substring(2)}`,type:"用户操作密钥",description:"基于用户ID、操作类型和数据内容生成的密钥",input:{userId:a.userId,operation:a.operation,data:{from:a.from,to:a.to,amount:a.amount}},key:i,timestamp:new Date().toISOString()};s(o=>[t,...o])},v=()=>{s([])};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"幂等性密钥生成演示"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"内容哈希密钥配置"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"API端点"}),e.jsx("input",{type:"text",value:r.endpoint,onChange:i=>n(t=>({...t,endpoint:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"金额"}),e.jsx("input",{type:"number",value:r.amount,onChange:i=>n(t=>({...t,amount:Number(i.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"货币"}),e.jsxs("select",{value:r.currency,onChange:i=>n(t=>({...t,currency:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"CNY",children:"CNY"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"用户ID"}),e.jsx("input",{type:"text",value:r.userId,onChange:i=>n(t=>({...t,userId:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"描述"}),e.jsx("input",{type:"text",value:r.description,onChange:i=>n(t=>({...t,description:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("button",{onClick:p,className:"w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600",children:"生成内容哈希密钥"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"用户操作密钥配置"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"用户ID"}),e.jsx("input",{type:"text",value:a.userId,onChange:i=>u(t=>({...t,userId:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"操作类型"}),e.jsxs("select",{value:a.operation,onChange:i=>u(t=>({...t,operation:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"transfer",children:"转账"}),e.jsx("option",{value:"payment",children:"支付"}),e.jsx("option",{value:"withdrawal",children:"提现"}),e.jsx("option",{value:"deposit",children:"充值"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"转出账户"}),e.jsx("input",{type:"text",value:a.from,onChange:i=>u(t=>({...t,from:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"转入账户"}),e.jsx("input",{type:"text",value:a.to,onChange:i=>u(t=>({...t,to:i.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"金额"}),e.jsx("input",{type:"number",value:a.amount,onChange:i=>u(t=>({...t,amount:Number(i.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("button",{onClick:j,className:"w-full bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600",children:"生成用户操作密钥"})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("button",{onClick:g,className:"bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600",children:"生成客户端密钥"}),e.jsx("button",{onClick:y,className:"bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600",children:"生成UUID密钥"}),e.jsx("button",{onClick:f,className:"bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600",children:"生成时间戳密钥"}),e.jsx("button",{onClick:v,className:"bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600",children:"清空示例"})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"密钥生成示例"}),l.length===0?e.jsx("div",{className:"text-gray-500 text-center py-8",children:"点击上方按钮生成不同类型的幂等性密钥示例"}):e.jsx("div",{className:"space-y-4",children:l.map(i=>e.jsxs("div",{className:"p-4 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${i.type==="内容哈希密钥"?"bg-blue-100 text-blue-800":i.type==="客户端唯一密钥"?"bg-green-100 text-green-800":i.type==="UUID密钥"?"bg-yellow-100 text-yellow-800":i.type==="时间戳密钥"?"bg-indigo-100 text-indigo-800":"bg-purple-100 text-purple-800"}`,children:i.type})}),e.jsx("div",{className:"text-sm text-gray-500",children:new Date(i.timestamp).toLocaleTimeString()})]}),e.jsx("div",{className:"mb-3",children:e.jsx("p",{className:"text-sm text-gray-600",children:i.description})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-700 mb-2",children:"输入数据"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded-md",children:e.jsx("pre",{className:"text-xs text-gray-800 whitespace-pre-wrap",children:JSON.stringify(i.input,null,2)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-700 mb-2",children:"生成的密钥"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded-md",children:e.jsx("div",{className:"font-mono text-sm text-gray-800 break-all",children:i.key})})]})]})]},i.id))})]}),e.jsxs("div",{className:"bg-blue-50 p-6 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-4",children:"密钥类型说明"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium mb-2",children:"确定性密钥"}),e.jsxs("ul",{className:"space-y-1",children:[e.jsxs("li",{children:["• ",e.jsx("strong",{children:"内容哈希密钥"}),"：基于请求内容生成，相同内容产生相同密钥"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"用户操作密钥"}),"：结合用户ID和操作类型，适用于用户级别的幂等性"]})]})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium mb-2",children:"唯一性密钥"}),e.jsxs("ul",{className:"space-y-1",children:[e.jsxs("li",{children:["• ",e.jsx("strong",{children:"客户端密钥"}),"：基于时间戳和随机数，每次都不同"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"UUID密钥"}),"：标准UUID格式，全局唯一"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"时间戳密钥"}),"：包含时间信息的唯一标识符"]})]})]})]})]})]})},G=()=>e.jsx(k,{title:"幂等性支持",description:"学习如何实现请求幂等性，防止重复操作造成的副作用，确保系统的一致性和可靠性。",overview:[{title:"幂等性基础概念",items:["幂等性的定义和重要性","HTTP方法的幂等性特征","幂等性与安全性的区别","业务场景中的幂等性需求"]},{title:"实现策略",items:["幂等性键的生成和管理","请求去重和缓存机制","并发请求的处理方案","失败重试的幂等性保证"]},{title:"技术实现",items:["客户端幂等性键生成","服务端幂等性验证","分布式环境下的幂等性","幂等性缓存的生命周期管理"]}],examples:[{title:"基础幂等性演示",component:e.jsx(q,{}),description:"演示基本的幂等性请求处理，包括缓存命中和重复请求检测",observationPoints:["多次点击'执行支付'按钮，观察相同请求的缓存命中情况","注意第一次请求的执行时间较长，后续相同请求立即返回缓存结果","观察统计信息中各种状态请求的数量变化"],keyPoints:["相同的请求参数会生成相同的幂等性键","已完成的请求会直接返回缓存结果","正在进行的请求会等待完成而不是重复执行"],commonTraps:["幂等性键生成不稳定，相同请求产生不同的键","缓存无限增长导致内存泄漏","并发请求处理不当导致重复执行"],solutions:["使用稳定的键生成算法，对对象属性进行排序","设置合理的TTL和最大缓存大小","使用Promise缓存处理并发请求"]},{title:"并发请求测试",component:e.jsx(P,{}),description:"测试多个相同请求并发执行时的幂等性处理效果",observationPoints:["并发执行多个相同请求时，只有一个实际的API调用","其他请求都会等待第一个请求完成并返回相同结果","观察缓存命中率和实际API调用次数的对比"],keyPoints:["并发的相同请求只会执行一次实际操作","所有并发请求都会得到相同的结果","显著减少了服务器负载和响应时间"],commonTraps:["并发请求处理不当导致重复执行","Promise缓存管理错误导致内存泄漏","缺乏适当的错误处理机制"],solutions:["使用Promise缓存处理并发请求","实现适当的清理和超时机制","添加完善的错误处理和重试逻辑"],importantTips:["并发请求会共享同一个Promise实例","第一个请求失败时其他请求也会失败","合理设置并发请求的超时时间"]},{title:"键生成策略演示",component:e.jsx(U,{}),description:"展示不同类型请求的幂等性键生成策略和规则",observationPoints:["相同的请求参数总是生成相同的幂等性键","不同的请求参数会生成不同的幂等性键","客户端生成的键具有时间戳和随机性"],keyPoints:["基于请求内容的键确保相同操作的一致性","客户端生成的键适用于需要强制唯一性的场景","键生成算法需要考虑参数顺序和数据类型"],commonTraps:["对象属性顺序不一致导致不同的键","浮点数精度问题影响键的稳定性","忽略数据类型差异导致键冲突"],solutions:["对对象属性进行排序确保一致性","使用固定精度处理浮点数","在键生成时考虑数据类型信息"],importantTips:["相同的请求内容必须生成相同的键","键生成算法要考虑所有相关参数","客户端键适用于强制唯一性场景"]}],tutorial:{concepts:["幂等性是指多次执行相同操作的结果与执行一次的结果相同的特性","幂等性键是基于请求内容生成的唯一标识符，用于识别相同的请求","请求缓存存储已执行请求的结果，避免重复执行相同操作","并发控制确保同时到达的相同请求只执行一次","TTL（生存时间）机制防止缓存无限增长和过期数据问题"],steps:["创建IdempotencyManager实例，配置缓存参数","为每个请求生成幂等性键（基于方法、URL、参数等）","检查缓存中是否存在相同键的请求结果","如果存在且已完成，直接返回缓存结果","如果正在进行，等待该请求完成","如果不存在，执行新请求并缓存结果","定期清理过期的缓存条目"],tips:["幂等性键应该包含所有影响结果的请求参数","对象属性需要排序以确保键的一致性","设置合理的缓存TTL，平衡性能和数据新鲜度","失败的请求应该允许重试，不应该永久缓存","在高并发场景下使用Promise缓存避免重复执行"]},interview:{questions:[{question:"什么是幂等性？为什么在API设计中很重要？",answer:"幂等性是指多次执行相同操作的结果与执行一次的结果相同的特性。在API设计中很重要因为：1）防止重复操作导致的数据不一致；2）提高系统的可靠性和容错性；3）简化客户端的重试逻辑；4）减少不必要的资源消耗。常见的幂等操作包括GET、PUT、DELETE，而POST通常不是幂等的。"},{question:"如何设计一个有效的幂等性键生成策略？",answer:"有效的幂等性键生成策略应该考虑：1）包含所有影响结果的参数（方法、URL、请求体、用户ID等）；2）确保相同请求总是生成相同的键（对象属性排序、数据类型标准化）；3）键的唯一性和冲突概率；4）键的长度和性能考虑；5）安全性（避免敏感信息泄露）。可以使用哈希算法（如SHA-256）或组合多个字段来生成键。"},{question:"如何处理幂等性实现中的并发问题？",answer:"处理并发问题的方法：1）使用Promise缓存，让后续相同请求等待第一个请求完成；2）实现分布式锁确保同一时间只有一个请求在执行；3）使用原子操作和事务确保数据一致性；4）设计合理的重试和超时机制；5）考虑使用消息队列串行化处理相同请求。关键是确保相同的请求在任何时候都只执行一次。"},{question:"幂等性缓存的TTL应该如何设置？",answer:"TTL设置需要平衡多个因素：1）业务特性：支付等关键操作可能需要较长TTL（几小时到几天），查询操作可能只需要几分钟；2）数据变化频率：频繁变化的数据需要较短TTL；3）系统资源：内存限制影响可缓存的数据量；4）用户体验：过短的TTL可能导致重复执行，过长可能返回过期数据。通常设置为几分钟到几小时，并提供手动清除机制。"},{question:"在微服务架构中如何实现分布式幂等性？",answer:"分布式幂等性实现方案：1）使用分布式缓存（Redis）存储幂等性键和结果；2）在数据库层面使用唯一约束防止重复插入；3）实现分布式锁确保全局唯一性；4）使用消息队列的幂等性特性；5）在API网关层统一处理幂等性；6）设计幂等性令牌机制，客户端先获取令牌再执行操作。关键是确保所有服务实例共享相同的幂等性状态。"}],keyPoints:["幂等性是确保系统可靠性和数据一致性的重要机制","幂等性键的生成策略直接影响系统的正确性和性能","并发控制是幂等性实现中的关键技术挑战","合理的缓存管理策略平衡性能和资源使用","分布式环境下的幂等性需要考虑一致性和可用性"]},bestPractices:{dos:["基于请求内容生成稳定的幂等性键","对请求参数进行排序和标准化处理","使用Promise缓存处理并发的相同请求","设置合理的缓存TTL和大小限制","为失败的请求提供重试机制","实现完善的缓存清理和监控机制","在关键业务操作中强制使用幂等性"],donts:["不要在幂等性键中包含时间戳等变化的值","不要忽略对象属性顺序对键生成的影响","不要永久缓存失败的请求结果","不要在幂等性键中包含敏感信息","不要忽略缓存的内存管理和清理","不要在所有操作中盲目使用幂等性","不要忽略分布式环境下的一致性问题"],patterns:["单例模式：IdempotencyManager确保全局唯一的缓存管理","策略模式：支持不同的键生成和缓存策略","装饰器模式：为现有请求添加幂等性功能","观察者模式：监控缓存状态和清理事件","工厂模式：根据请求类型创建不同的幂等性处理器","代理模式：透明地为请求添加幂等性支持"]}});export{G as default};
