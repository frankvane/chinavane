var A=Object.defineProperty;var R=(n,t,a)=>t in n?A(n,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[t]=a;var w=(n,t,a)=>R(n,typeof t!="symbol"?t+"":t,a);import{r as o,j as e}from"./index-C7SuDyTR.js";import{C as I}from"./ComponentTemplate-BzrYXZsv.js";import{a as C}from"./index-NIGUFBhG.js";class S{constructor(){w(this,"activeRequests",new Map);w(this,"requestCounter",0)}createRequest(t){const a=t||`request_${++this.requestCounter}`,i=new AbortController;return this.activeRequests.set(a,i),{requestId:a,abortController:i}}cancelRequest(t){const a=this.activeRequests.get(t);return a?(a.abort(),this.activeRequests.delete(t),!0):!1}cancelAllRequests(){const t=this.activeRequests.size;return this.activeRequests.forEach(a=>a.abort()),this.activeRequests.clear(),t}completeRequest(t){this.activeRequests.delete(t)}getActiveRequestCount(){return this.activeRequests.size}getActiveRequestIds(){return Array.from(this.activeRequests.keys())}}const m=new S,q=async(n,t,a=0)=>{const{requestId:i,abortController:h}=m.createRequest(t);try{a>0&&await new Promise(x=>setTimeout(x,a));const d=await C.get(n,{signal:h.signal});return m.completeRequest(i),{data:d.data,requestId:i,cancelled:!1}}catch(d){throw m.completeRequest(i),C.isCancel(d)?{cancelled:!0,requestId:i,message:"Request cancelled"}:{cancelled:!1,requestId:i,error:d}}},$=()=>{const[n,t]=o.useState(!1),[a,i]=o.useState(null),[h,d]=o.useState(""),[x,b]=o.useState(""),[f,p]=o.useState(0),v=()=>{p(m.getActiveRequestCount())};o.useEffect(()=>{const g=setInterval(v,100);return()=>clearInterval(g)},[]);const j=async(g,r)=>{t(!0),d(""),i(null);try{const s=await q("https://jsonplaceholder.typicode.com/posts/1",void 0,g);b(s.requestId),i({...s.data,requestType:r,requestId:s.requestId})}catch(s){s.cancelled?d(`${r} 请求已取消 (ID: ${s.requestId})`):d(`${r} 请求失败: ${s.message||"未知错误"}`)}finally{t(!1),b("")}},y=()=>{x&&m.cancelRequest(x)&&(d(`请求已取消 (ID: ${x})`),t(!1),b(""))};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>j(1e3,"慢请求"),disabled:n,className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50",children:"发起慢请求 (1秒)"}),e.jsx("button",{onClick:()=>j(3e3,"超慢请求"),disabled:n,className:"px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:opacity-50",children:"发起超慢请求 (3秒)"}),e.jsx("button",{onClick:y,disabled:!n||!x,className:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50",children:"取消当前请求"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"请求状态"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"当前状态:"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${n?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:n?"请求中":"空闲"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"当前请求ID:"}),e.jsx("span",{className:"font-mono text-xs",children:x||"无"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"活跃请求数:"}),e.jsx("span",{className:"font-bold text-blue-600",children:f})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"请求结果"}),n&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:"请求进行中..."})]}),h&&e.jsx("div",{className:"text-red-600 text-sm bg-red-50 p-2 rounded",children:h}),a&&e.jsxs("div",{className:"text-green-600 text-sm bg-green-50 p-2 rounded",children:[e.jsx("div",{children:"✅ 请求成功"}),e.jsxs("div",{children:["类型: ",a.requestType]}),e.jsxs("div",{children:["ID: ",a.requestId]}),e.jsxs("div",{children:["标题: ",a.title]})]})]})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-semibold text-blue-800 mb-2",children:"💡 功能说明"}),e.jsxs("ul",{className:"text-sm text-blue-700 space-y-1",children:[e.jsx("li",{children:"• 慢请求和超慢请求模拟不同的网络延迟情况"}),e.jsx("li",{children:"• 每个请求都有唯一的 ID 用于标识和管理"}),e.jsx("li",{children:"• 取消按钮只在有活跃请求时可用"}),e.jsx("li",{children:"• 活跃请求数实时显示当前正在进行的请求数量"}),e.jsx("li",{children:"• 取消的请求会抛出 AbortError 异常"})]})]})]})},D=()=>{const[n,t]=o.useState([]),[a,i]=o.useState(0),[h,d]=o.useState(!1),x=()=>{i(m.getActiveRequestCount())};o.useEffect(()=>{const s=setInterval(x,100);return()=>clearInterval(s)},[]);const b=()=>{const c=[1e3,1500,2e3,2500,3e3].map((l,u)=>({id:`batch_${Date.now()}_${u}`,status:"pending",startTime:Date.now(),delay:l}));t(c),d(!0),c.forEach(l=>{f(l)})},f=async s=>{t(c=>c.map(l=>l.id===s.id?{...l,status:"loading"}:l));try{const c=await q(`https://jsonplaceholder.typicode.com/posts/${Math.floor(Math.random()*10)+1}`,s.id,s.delay);t(l=>l.map(u=>u.id===s.id?{...u,status:"success",endTime:Date.now(),result:c.data}:u))}catch(c){t(l=>l.map(u=>u.id===s.id?{...u,status:c.cancelled?"cancelled":"error",endTime:Date.now(),error:c.message||"请求失败"}:u))}},p=()=>{const s=m.cancelAllRequests();d(!1),t(c=>c.map(l=>l.status==="loading"?{...l,status:"cancelled",endTime:Date.now()}:l)),console.log(`已取消 ${s} 个请求`)},v=s=>{m.cancelRequest(s)&&t(l=>l.map(u=>u.id===s?{...u,status:"cancelled",endTime:Date.now()}:u))},j=()=>{t([]),d(!1)},y=s=>{switch(s){case"pending":return"⏳";case"loading":return"🔄";case"success":return"✅";case"error":return"❌";case"cancelled":return"🚫";default:return"❓"}},g=s=>{switch(s){case"pending":return"text-gray-600 bg-gray-100";case"loading":return"text-blue-600 bg-blue-100";case"success":return"text-green-600 bg-green-100";case"error":return"text-red-600 bg-red-100";case"cancelled":return"text-orange-600 bg-orange-100";default:return"text-gray-600 bg-gray-100"}},r=s=>s.endTime?`${s.endTime-s.startTime}ms`:"-";return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:b,disabled:h,className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50",children:"发起批量请求 (5个)"}),e.jsx("button",{onClick:p,disabled:!h||a===0,className:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50",children:"取消所有请求"}),e.jsx("button",{onClick:j,disabled:h,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 disabled:opacity-50",children:"清除历史"})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h4",{className:"font-semibold",children:"批量请求状态"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("span",{className:"mr-4",children:["活跃请求: ",e.jsx("span",{className:"font-bold text-blue-600",children:a})]}),e.jsxs("span",{children:["总请求: ",e.jsx("span",{className:"font-bold",children:n.length})]})]})]}),n.length===0?e.jsx("div",{className:"text-gray-500 text-center py-4",children:'点击"发起批量请求"开始演示'}):e.jsx("div",{className:"space-y-2",children:n.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-white rounded border",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"text-lg",children:y(s.status)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-mono text-xs text-gray-500",children:s.id}),e.jsxs("div",{className:"text-sm",children:["延迟: ",s.delay,"ms | 耗时: ",r(s)]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${g(s.status)}`,children:s.status}),s.status==="loading"&&e.jsx("button",{onClick:()=>v(s.id),className:"px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600",children:"取消"})]})]},s.id))})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-semibold text-blue-800 mb-2",children:"💡 功能说明"}),e.jsxs("ul",{className:"text-sm text-blue-700 space-y-1",children:[e.jsx("li",{children:"• 批量请求演示5个并发请求，每个有不同的延迟时间"}),e.jsx("li",{children:"• 可以取消所有进行中的请求，也可以单独取消某个请求"}),e.jsx("li",{children:"• 请求状态用不同的图标和颜色表示，便于区分"}),e.jsx("li",{children:"• 实时显示每个请求的耗时和状态变化"}),e.jsx("li",{children:"• 活跃请求数实时更新，显示当前正在进行的请求数量"})]})]})]})},E=()=>{const[n,t]=o.useState(!1),[a,i]=o.useState([]),[h,d]=o.useState(0),[x,b]=o.useState(0),f=()=>{d(m.getActiveRequestCount())};o.useEffect(()=>{const r=setInterval(f,100);return()=>clearInterval(r)},[]);const p=(r,s)=>{const c={id:`log_${Date.now()}_${Math.random()}`,timestamp:new Date().toLocaleTimeString(),type:r,message:s};i(l=>[c,...l].slice(0,20))},v=async()=>{t(!0),i([]),p("start","开始模拟页面切换场景"),[{delay:4e3,name:"用户数据"},{delay:5e3,name:"订单列表"},{delay:6e3,name:"商品信息"},{delay:7e3,name:"统计数据"}].forEach((c,l)=>{const u=`page_request_${l}`;p("start",`发起${c.name}请求 (${c.delay}ms)`),q(`https://jsonplaceholder.typicode.com/posts/${l+1}`,u,c.delay).then(N=>{p("success",`${c.name}请求完成 (ID: ${N.requestId})`)}).catch(N=>{N.cancelled&&p("cancelled",`${c.name}请求已取消 (ID: ${N.requestId})`)})}),b(2);const s=setInterval(()=>{b(c=>{if(c<=1){clearInterval(s);const l=m.cancelAllRequests();return p("switch",`页面切换！取消了 ${l} 个活跃请求`),t(!1),0}return c-1})},1e3)},j=()=>{i([])},y=r=>{switch(r){case"start":return"🚀";case"success":return"✅";case"cancelled":return"🚫";case"switch":return"🔄";default:return"📝"}},g=r=>{switch(r){case"start":return"text-blue-600";case"success":return"text-green-600";case"cancelled":return"text-orange-600";case"switch":return"text-purple-600";default:return"text-gray-600"}};return o.useEffect(()=>()=>{const r=m.cancelAllRequests();r>0&&console.log(`组件卸载：取消了 ${r} 个活跃请求`)},[]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("button",{onClick:v,disabled:n,className:"px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:opacity-50",children:"模拟页面切换"}),e.jsx("button",{onClick:j,disabled:n,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 disabled:opacity-50",children:"清除日志"}),x>0&&e.jsxs("div",{className:"px-3 py-1 bg-yellow-100 text-yellow-800 rounded text-sm font-medium",children:[x,"秒后切换页面..."]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"当前状态"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"模拟状态:"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${n?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:n?"进行中":"空闲"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"活跃请求数:"}),e.jsx("span",{className:"font-bold text-blue-600",children:h})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"日志条数:"}),e.jsx("span",{className:"font-bold",children:a.length})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"操作日志"}),e.jsx("div",{className:"max-h-40 overflow-y-auto space-y-1",children:a.length===0?e.jsx("div",{className:"text-gray-500 text-sm text-center py-2",children:'点击"模拟页面切换"开始演示'}):a.map(r=>e.jsxs("div",{className:"flex items-start space-x-2 text-xs p-2 bg-white rounded",children:[e.jsx("span",{className:"text-sm",children:y(r.type)}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:`font-medium ${g(r.type)}`,children:r.message}),e.jsx("span",{className:"text-gray-400 ml-2",children:r.timestamp})]})})]},r.id))})]})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[e.jsx("h4",{className:"font-semibold text-blue-800 mb-2",children:"💡 功能说明"}),e.jsxs("ul",{className:"text-sm text-blue-700 space-y-1",children:[e.jsx("li",{children:"• 模拟页面加载时发起多个长时间请求（4-7秒）"}),e.jsx("li",{children:"• 2秒后自动触发页面切换，取消所有活跃请求"}),e.jsx("li",{children:"• 操作日志实时显示请求的发起、完成和取消状态"}),e.jsx("li",{children:"• 演示了 SPA 应用中页面切换时的资源清理机制"}),e.jsx("li",{children:"• 组件卸载时也会自动清理所有活跃请求"})]})]})]})},M=()=>{const n=[{title:"核心概念",items:["AbortController 和 AbortSignal API","请求生命周期管理和状态跟踪","取消令牌模式和请求标识","内存泄漏防护和资源清理"]},{title:"主要优势",items:["避免无效请求浪费带宽资源","防止过期响应覆盖新数据","提升应用响应速度和稳定性","减少服务器负载和网络拥塞"]},{title:"适用场景",items:["搜索输入框的实时查询","页面切换时的请求清理","长时间运行的数据加载","用户主动取消的操作"]},{title:"注意事项",items:["正确处理取消异常和错误状态","避免取消已完成的请求","注意清理定时器和事件监听","考虑用户体验和反馈提示"]}];return e.jsx(I,{title:"请求取消",description:"学习如何实现请求取消机制，包括 AbortController API、单个请求取消、批量取消和页面切换时的全局取消，提升应用性能和用户体验。",overview:n,examples:[{title:"单个请求取消",component:e.jsx($,{}),description:"演示如何取消单个正在进行的请求，包括慢请求和超慢请求的取消操作。",observationPoints:["点击慢请求或超慢请求按钮，观察请求状态和加载动画","在请求进行中点击取消按钮，观察请求立即停止","活跃请求数会实时更新，显示当前正在进行的请求数量","取消的请求会显示相应的错误信息和状态"],keyPoints:["AbortController 提供了标准的请求取消机制","每个请求都有唯一的 ID 用于标识和管理","取消请求会触发 AbortError 异常","请求管理器跟踪所有活跃请求的状态"],commonTraps:["忘记处理 AbortError 导致未捕获异常","取消已完成的请求导致状态混乱","没有清理请求引用导致内存泄漏","重复取消同一个请求"],solutions:["使用 axios.isCancel() 检查取消状态","在请求完成后及时清理引用","实现请求状态管理和生命周期跟踪","添加请求 ID 验证和重复检查"],importantTips:["取消请求不会阻止网络传输，但会忽略响应","合理设置请求超时时间配合取消机制","考虑用户体验，提供清晰的取消反馈"]},{title:"批量请求取消",component:e.jsx(D,{}),description:"演示如何管理和取消多个并发请求，包括批量发起和批量取消操作。",observationPoints:["点击发起批量请求，观察5个请求同时开始执行","每个请求有不同的延迟时间，模拟真实场景","点击取消所有请求，观察所有进行中的请求立即停止","请求状态用不同颜色和图标表示，便于区分"],keyPoints:["请求管理器统一管理所有活跃请求","支持按 ID 取消单个请求或批量取消","每个请求都有独立的状态和错误处理","实时显示请求进度和耗时统计"],commonTraps:["并发请求过多导致浏览器限制","批量取消时状态更新不及时","请求完成和取消的竞态条件","内存中积累过多请求历史"],solutions:["控制并发请求数量，使用队列管理","使用状态管理确保 UI 同步更新","正确处理请求完成和取消的时序","定期清理已完成的请求记录"],importantTips:["批量操作特别适用于数据同步和批量上传","考虑实现请求优先级和依赖关系","监控网络状况，动态调整并发数"]},{title:"页面切换时取消",component:e.jsx(E,{}),description:"演示页面切换或组件卸载时自动取消所有活跃请求的机制。",observationPoints:["点击模拟页面切换，观察多个长时间请求开始执行","2秒后自动触发页面切换，所有活跃请求被取消","操作日志实时显示请求的发起、完成和取消状态","活跃请求数在页面切换后归零"],keyPoints:["useEffect 清理函数确保组件卸载时取消请求","全局请求管理器提供统一的取消接口","页面切换时的资源清理是性能优化的关键","日志记录有助于调试和监控请求状态"],commonTraps:["忘记在组件卸载时清理请求","页面切换过快导致状态混乱","清理时机不当影响正常请求","内存泄漏和事件监听器未清理"],solutions:["使用 useEffect 返回清理函数","实现防抖机制避免频繁切换","区分正常完成和主动取消的请求","建立完整的资源清理机制"],importantTips:["页面切换取消是 SPA 应用的最佳实践","考虑保存重要请求的状态用于恢复","结合路由守卫实现更精细的控制"]}],tutorial:{concepts:["**AbortController API**：现代浏览器提供的标准请求取消接口","**AbortSignal 信号**：传递给请求的取消信号，支持事件监听","**请求生命周期**：从创建到完成或取消的完整过程管理","**取消令牌模式**：为每个请求分配唯一标识符便于管理","**资源清理机制**：确保取消的请求不会造成内存泄漏","**状态同步更新**：UI 状态与请求状态的实时同步"],steps:["创建 RequestManager 类管理所有活跃请求","为每个请求生成唯一 ID 和 AbortController","实现单个请求取消和批量取消方法","在 axios 请求中传入 AbortSignal","正确处理 AbortError 和请求完成状态","在组件卸载时清理所有活跃请求"],tips:["使用 axios.isCancel() 检查是否为取消错误","为请求设置合理的超时时间作为备选方案","考虑实现请求重试机制配合取消功能","在开发工具中监控网络请求的取消状态","对于重要操作，提供用户确认取消的机制","结合 loading 状态提供良好的用户反馈"]},interview:{questions:[{question:"AbortController 是什么？它是如何工作的？",answer:"AbortController 是 Web API 提供的请求取消接口。工作原理：1) 创建 AbortController 实例；2) 将其 signal 属性传给 fetch 或 axios；3) 调用 abort() 方法取消请求；4) 请求会抛出 AbortError 异常。它基于观察者模式，signal 对象监听 abort 事件，当调用 abort() 时通知所有监听者。"},{question:"如何在 React 中正确处理请求取消？",answer:"React 中处理请求取消的最佳实践：1) 在 useEffect 中发起请求；2) 返回清理函数调用 abort()；3) 使用 useState 管理请求状态；4) 用 try-catch 捕获 AbortError；5) 检查组件是否已卸载再更新状态。关键是确保组件卸载时取消所有活跃请求，避免内存泄漏和状态更新错误。"},{question:"页面切换时为什么要取消请求？如何实现？",answer:"页面切换时取消请求的原因：1) 避免无效响应覆盖新页面数据；2) 节省带宽和服务器资源；3) 防止内存泄漏；4) 提升应用性能。实现方式：1) 全局请求管理器跟踪活跃请求；2) 路由切换时调用批量取消；3) 组件卸载时清理请求；4) 使用 beforeunload 事件处理页面关闭。"},{question:"请求取消和请求超时有什么区别？",answer:"主要区别：1) **触发方式**：取消是主动调用 abort()，超时是时间到达自动触发；2) **错误类型**：取消抛出 AbortError，超时抛出 TimeoutError；3) **使用场景**：取消用于用户主动停止或页面切换，超时用于网络异常保护；4) **实现机制**：取消基于 AbortController，超时基于 setTimeout；5) **资源释放**：取消立即释放，超时等待超时时间。两者可以结合使用提供更好的用户体验。"}],keyPoints:["AbortController 是现代浏览器的标准 API，兼容性良好","请求取消不会阻止网络传输，但会忽略响应结果","正确的错误处理是请求取消机制的关键部分","页面切换时的请求清理是 SPA 应用的最佳实践","请求管理器模式有助于统一管理复杂的请求状态","结合 loading 状态和用户反馈提升交互体验"]},bestPractices:{dos:["为每个请求创建独立的 AbortController 实例","在组件卸载时清理所有活跃请求","使用唯一 ID 标识和管理请求","正确处理 AbortError 和其他异常","实现请求状态的实时更新和同步","提供清晰的用户反馈和取消按钮","结合超时机制提供双重保护","监控和记录请求的取消情况"],donts:["不要重复取消已经完成的请求","不要忘记清理请求引用和事件监听","不要在请求取消后继续更新组件状态","不要忽略 AbortError 的异常处理","不要在全局范围内滥用请求取消","不要取消关键的业务请求如支付","不要在取消请求后立即发起相同请求","不要依赖请求取消作为唯一的错误处理机制"],patterns:["**请求管理器模式**：统一管理所有请求的生命周期","**取消令牌模式**：为请求分配唯一标识符便于管理","**清理函数模式**：useEffect 返回清理函数处理资源释放","**状态机模式**：明确定义请求的各种状态转换","**观察者模式**：AbortSignal 基于事件监听实现取消通知","**工厂模式**：统一创建带取消功能的请求实例","**装饰器模式**：为现有请求函数添加取消能力"]}})};export{M as default};
