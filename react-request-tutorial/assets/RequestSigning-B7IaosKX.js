var A=Object.defineProperty;var f=(t,s,i)=>s in t?A(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i;var S=(t,s,i)=>f(t,typeof s!="symbol"?s+"":s,i);import{r as d,j as e}from"./index-C7SuDyTR.js";import{C}from"./ComponentTemplate-BzrYXZsv.js";class v{constructor(s,i="HMAC-SHA256"){S(this,"secretKey");this.secretKey=s}async generateSignature(s,i,o){const m={data:typeof s=="string"?s:JSON.stringify(s),timestamp:i,nonce:o},n=Object.keys(m).sort().map(c=>`${c}=${m[c]}`).join("&"),r=new TextEncoder,u=r.encode(this.secretKey),p=r.encode(n),a=await crypto.subtle.importKey("raw",u,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),g=await crypto.subtle.sign("HMAC",a,p);return Array.from(new Uint8Array(g)).map(c=>c.toString(16).padStart(2,"0")).join("")}async verifySignature(s,i,o,m){return await this.generateSignature(s,i,o)===m}generateNonce(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}isTimestampValid(s,i=3e5){const o=Date.now();return Math.abs(o-s)<=i}}const H=()=>{const[t]=d.useState(()=>new v("my-secret-key")),[s,i]=d.useState('{ "userId": 123, "action": "transfer" }'),[o,m]=d.useState(""),[n,r]=d.useState(null),[u,p]=d.useState(Date.now()),[a,g]=d.useState(""),c=d.useCallback(async()=>{try{const l=Date.now(),b=t.generateNonce(),h=await t.generateSignature(s,l,b);p(l),g(b),m(h),r(null)}catch(l){console.error("签名生成失败:",l)}},[t,s]),x=d.useCallback(async()=>{try{const l=await t.verifySignature(s,u,a,o);r(l)}catch(l){console.error("签名验证失败:",l),r(!1)}},[t,s,u,a,o]);return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"请求签名生成与验证"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"请求数据 (JSON)"}),e.jsx("textarea",{value:s,onChange:l=>i(l.target.value),className:"w-full p-3 border border-gray-300 rounded-md font-mono text-sm",rows:3,placeholder:"输入要签名的请求数据..."})]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("button",{onClick:c,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"生成签名"}),o&&e.jsx("button",{onClick:x,className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700",children:"验证签名"})]}),o&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"时间戳:"}),e.jsx("code",{className:"text-sm bg-gray-100 p-2 rounded",children:u})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"随机数 (Nonce):"}),e.jsx("code",{className:"text-sm bg-gray-100 p-2 rounded",children:a})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"签名:"}),e.jsx("code",{className:"text-sm bg-gray-100 p-2 rounded break-all",children:o})]})]}),n!==null&&e.jsxs("div",{className:`p-3 rounded-md ${n?"bg-green-100 text-green-800 border border-green-200":"bg-red-100 text-red-800 border border-red-200"}`,children:["签名验证: ",n?"✅ 通过":"❌ 失败"]})]})]})})},k=()=>{const[t,s]=d.useState({secretKey:"my-secret-key",algorithm:"HMAC-SHA256",timestampWindow:3e5,nonceLength:16}),[i,o]=d.useState([]),m=d.useCallback(async()=>{const n=new v(t.secretKey,t.algorithm),r={userId:123,action:"test"},u=[],p=Date.now(),a=n.generateNonce(),g=await n.generateSignature(r,p,a),c=await n.verifySignature(r,p,a,g);u.push({test:"正常签名验证",result:c?"通过":"失败",status:c?"success":"error"});const x={userId:456,action:"test"},l=await n.verifySignature(x,p,a,g);u.push({test:"数据篡改检测",result:l?"失败（未检测到篡改）":"通过（正确拒绝）",status:l?"error":"success"});const b=Date.now()-t.timestampWindow-1e3,h=n.isTimestampValid(b,t.timestampWindow);u.push({test:"时间戳过期检测",result:h?"失败（未检测到过期）":"通过（正确拒绝）",status:h?"error":"success"}),o(u)},[t]);return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"安全配置管理"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"密钥"}),e.jsx("input",{type:"text",value:t.secretKey,onChange:n=>s(r=>({...r,secretKey:n.target.value})),className:"w-full p-2 border border-gray-300 rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"算法"}),e.jsxs("select",{value:t.algorithm,onChange:n=>s(r=>({...r,algorithm:n.target.value})),className:"w-full p-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"HMAC-SHA256",children:"HMAC-SHA256"}),e.jsx("option",{value:"HMAC-SHA512",children:"HMAC-SHA512"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"时间戳窗口 (毫秒)"}),e.jsx("input",{type:"number",value:t.timestampWindow,onChange:n=>s(r=>({...r,timestampWindow:parseInt(n.target.value)})),className:"w-full p-2 border border-gray-300 rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nonce长度"}),e.jsx("input",{type:"number",value:t.nonceLength,onChange:n=>s(r=>({...r,nonceLength:parseInt(n.target.value)})),className:"w-full p-2 border border-gray-300 rounded-md"})]})]}),e.jsx("button",{onClick:m,className:"px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 mb-4",children:"运行安全测试"}),i.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"测试结果:"}),i.map((n,r)=>e.jsxs("div",{className:`p-3 rounded-md ${n.status==="success"?"bg-green-100 text-green-800 border border-green-200":"bg-red-100 text-red-800 border border-red-200"}`,children:[e.jsxs("strong",{children:[n.test,":"]})," ",n.result]},r))]})]})})},T=()=>{const[t]=d.useState(()=>new v("production-secret-key")),[s,i]=d.useState([]),[o,m]=d.useState(!1),n=d.useCallback(async(a,g)=>{m(!0);try{const c=Date.now(),x=t.generateNonce(),l=await t.generateSignature(g,c,x),b=Math.random().toString(36).substring(2,15),h={id:b,endpoint:a,data:g,timestamp:c,nonce:x,signature:l,status:"pending",createdAt:new Date().toLocaleTimeString()};i(y=>[h,...y.slice(0,9)]),setTimeout(async()=>{const y=await t.verifySignature(g,c,x,l),N=t.isTimestampValid(c);i(w=>w.map(j=>j.id===b?{...j,status:y&&N?"success":"failed",validationResult:{signatureValid:y,timestampValid:N}}:j)),m(!1)},1e3+Math.random()*2e3)}catch(c){console.error("API请求失败:",c),m(!1)}},[t]),r=()=>{n("/api/transfer",{fromAccount:"123456789",toAccount:"987654321",amount:1e3,currency:"USD"})},u=()=>{n("/api/user/update",{userId:12345,email:"user@example.com",profile:{name:"John Doe",age:30}})},p=()=>{n("/api/resource/delete",{resourceId:"res_"+Math.random().toString(36).substring(2,10),reason:"User requested deletion"})};return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"实际应用场景"}),e.jsxs("div",{className:"flex flex-wrap gap-3 mb-6",children:[e.jsx("button",{onClick:r,disabled:o,className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50",children:"转账请求"}),e.jsx("button",{onClick:u,disabled:o,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:"用户更新"}),e.jsx("button",{onClick:p,disabled:o,className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:"删除资源"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"API请求历史:"}),s.length===0?e.jsx("p",{className:"text-gray-500 text-center py-8",children:"暂无API请求记录"}):s.map(a=>e.jsxs("div",{className:`p-4 rounded-lg border ${a.status==="success"?"bg-green-50 border-green-200":a.status==="failed"?"bg-red-50 border-red-200":"bg-yellow-50 border-yellow-200"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:a.endpoint}),e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full ${a.status==="success"?"bg-green-100 text-green-800":a.status==="failed"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:a.status==="pending"?"处理中...":a.status==="success"?"成功":"失败"})]}),e.jsx("span",{className:"text-sm text-gray-500",children:a.createdAt})]}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-1",children:[e.jsxs("div",{children:["签名:"," ",e.jsxs("code",{className:"bg-gray-100 px-1 rounded",children:[a.signature.substring(0,16),"..."]})]}),e.jsxs("div",{children:["时间戳:"," ",e.jsx("code",{className:"bg-gray-100 px-1 rounded",children:a.timestamp})]}),e.jsxs("div",{children:["Nonce:"," ",e.jsx("code",{className:"bg-gray-100 px-1 rounded",children:a.nonce})]}),a.validationResult&&e.jsxs("div",{className:"mt-2 text-xs",children:["签名验证:"," ",a.validationResult.signatureValid?"✅":"❌"," | 时间戳验证:"," ",a.validationResult.timestampValid?"✅":"❌"]})]})]},a.id))]})]})})},D=()=>e.jsx(C,{title:"请求签名",description:"学习如何实现请求签名机制，确保API请求的完整性和真实性，防止数据篡改和重放攻击",overview:[{title:"核心概念",items:["HMAC-SHA256签名算法：使用密钥和哈希算法生成数字签名，确保数据完整性和真实性。","时间戳验证：防止重放攻击，确保请求的时效性。","随机数(Nonce)：为每个请求生成唯一随机数，增加签名的不可预测性。","参数排序：对请求参数进行字典序排序，确保签名一致性。"]},{title:"主要优势",items:["防止数据篡改和重放攻击，提升API安全性","签名算法标准化，易于前后端集成","支持多种安全配置和灵活的时间窗口","便于监控和追踪请求的完整性"]},{title:"适用场景",items:["金融、支付等高安全性API请求","需要防止重放和篡改的业务接口","第三方API集成和开放平台","分布式系统的接口安全保护"]},{title:"注意事项",items:["密钥必须安全存储，避免前端硬编码","时间戳窗口需平衡安全性和可用性","参数排序和签名算法需前后端一致","签名验证失败要有详细日志和告警"]}],examples:[{title:"基础签名演示",component:e.jsx(H,{}),description:"演示请求签名的生成和验证过程",observationPoints:["输入请求数据后点击'生成签名'按钮观察签名生成过程","注意时间戳、随机数和签名的生成","点击'验证签名'按钮查看验证结果","尝试修改请求数据后重新验证观察验证失败的情况"],keyPoints:["签名基于请求数据、时间戳和随机数生成","相同数据在不同时间生成的签名不同","任何数据修改都会导致签名验证失败","HMAC-SHA256算法确保签名的安全性"],commonTraps:["忘记在签名中包含时间戳和随机数","客户端和服务端的参数排序不一致","使用不安全的哈希算法","密钥硬编码在客户端代码中"],solutions:["严格按照协议规范生成签名","使用标准的参数排序算法","选择安全的HMAC算法","密钥通过安全渠道获取和存储"],importantTips:["签名算法必须在客户端和服务端保持一致","时间戳用于防止重放攻击需要设置合理的时间窗口","随机数确保相同请求的签名每次都不同"]},{title:"安全配置管理",component:e.jsx(k,{}),description:"展示不同安全配置对签名验证的影响",observationPoints:["修改密钥、算法等配置参数","点击'运行安全测试'观察不同测试场景","查看正常验证、数据篡改检测、时间戳过期等测试结果","调整时间戳窗口大小观察对验证的影响"],keyPoints:["密钥是签名安全的核心必须妥善保管","算法选择影响签名的安全强度","时间戳窗口平衡安全性和可用性","系统能够检测各种攻击场景"],commonTraps:["使用弱密钥或默认密钥","时间戳窗口设置过大或过小","忽略对篡改数据的检测","不验证时间戳的有效性"],solutions:["使用强随机密钥并定期轮换","根据业务需求设置合适的时间窗口","实现完整的签名验证逻辑","添加时间戳有效性检查"],importantTips:["安全配置需要在开发和生产环境中保持一致","定期审查和更新安全配置","监控签名验证失败的情况及时发现攻击"]},{title:"实际应用场景",component:e.jsx(T,{}),description:"模拟真实API请求的签名验证流程",observationPoints:["点击不同类型的API请求按钮","观察请求的签名生成和验证过程","查看API请求历史和验证结果","注意请求状态的变化：处理中 → 成功/失败"],keyPoints:["每个API请求都有独立的签名","签名验证在服务端进行","验证失败的请求会被拒绝","请求历史帮助追踪和调试"],commonTraps:["在生产环境中使用测试密钥","忽略网络延迟对时间戳的影响","不处理签名验证失败的情况","缺乏请求日志和监控"],solutions:["为不同环境配置不同的密钥","考虑网络延迟设置合理的时间窗口","实现完善的错误处理机制","建立完整的日志和监控体系"],importantTips:["在实际应用中签名验证通常在API网关或中间件中实现","需要考虑高并发场景下的性能优化","建议结合其他安全措施如HTTPS、API限流等"]}],tutorial:{concepts:["HMAC-SHA256签名：基于密钥和哈希算法生成消息认证码，确保数据完整性和来源可信。","时间戳验证：签名中包含当前时间戳，限制请求有效期，防止重放攻击。","随机数(Nonce)：每个请求生成唯一随机数，防止相同请求被重放。","参数排序：对所有签名参数进行字典序排序，确保签名一致性。"],steps:["准备请求数据并序列化为JSON格式","生成当前时间的毫秒级时间戳","创建唯一的nonce值防止重放攻击","构造包含数据、时间戳、nonce的签名载荷","使用HMAC-SHA256算法计算消息认证码","将原始数据、时间戳、nonce和签名一起发送","服务端重新计算签名并验证时间戳有效性"],tips:["使用Web Crypto API确保签名计算的安全性","时间戳窗口建议设置为5-10分钟平衡安全性和可用性","密钥应该通过环境变量或密钥管理服务获取","记录签名验证失败的请求用于安全监控"]},interview:{questions:[{question:"什么是请求签名，为什么需要对API请求进行签名？",answer:"请求签名是使用密钥对请求内容进行加密哈希计算生成的唯一标识。主要作用：1）验证请求完整性，确保数据未被篡改；2）验证请求真实性，确认来自合法发送方；3）防止重放攻击，通过时间戳和nonce保证唯一性；4）提供不可否认性，发送方无法否认请求。"},{question:"HMAC-SHA256算法的工作原理是什么？",answer:"HMAC-SHA256基于哈希的消息认证码算法：1）使用共享密钥和SHA-256哈希函数；2）密钥与固定填充值异或运算；3）处理后的密钥与消息内容拼接；4）对拼接结果进行SHA-256哈希；5）再次与密钥异或和哈希运算；6）得到256位认证码。双重哈希设计确保无法在不知道密钥情况下伪造签名。"},{question:"如何有效防止请求签名的重放攻击？",answer:"防重放攻击方法：1）时间戳验证：签名包含当前时间戳，服务端验证是否在允许窗口内；2）随机数nonce：每个请求生成唯一随机数，服务端记录并拒绝重复；3）请求序列号：使用递增序列号确保顺序；4）会话令牌：结合用户会话信息增加唯一性。"},{question:"前端实现请求签名的安全注意事项有哪些？",answer:"前端签名安全要点：1）密钥管理：避免硬编码密钥，通过安全方式获取临时密钥；2）算法选择：使用标准加密算法；3）参数处理：确保签名参数一致性；4）时间同步：客户端与服务端时间同步；5）错误处理：不泄露签名敏感信息；6）HTTPS传输：防止签名截获。"},{question:"如何在生产环境中管理和轮换签名密钥？",answer:"密钥管理策略：1）使用专业密钥管理服务存储密钥；2）实现多版本密钥支持，支持平滑切换；3）定期轮换密钥（建议3-6个月）；4）密钥访问权限控制和审计；5）密钥泄露应急响应流程；6）开发、测试、生产环境密钥隔离。"}],keyPoints:["HMAC-SHA256提供强大的消息认证能力","时间戳和nonce是防重放攻击的核心机制","密钥安全管理是签名体系的基础","前端签名需要考虑密钥泄露风险","签名验证失败需要详细日志记录"]},bestPractices:{dos:["使用标准HMAC-SHA256算法生成签名，确保安全性和兼容性。","签名中必须包含时间戳和随机数，防止重放攻击。","密钥通过安全渠道获取和存储，避免前端硬编码。","前后端参数排序和签名算法保持完全一致。","定期轮换密钥，提升整体安全性。","签名验证失败时记录详细日志，便于追踪和告警。"],donts:["不要在前端代码中硬编码签名密钥。","不要忽略时间戳和nonce的有效性校验。","不要使用弱随机数生成器生成nonce。","不要跳过参数排序，避免签名不一致。","不要在日志或错误信息中暴露签名和密钥。","不要只依赖签名，忽略HTTPS等其他安全措施。"],patterns:["签名管理器模式：封装签名生成和验证逻辑，便于维护和扩展。","密钥轮换模式：支持多版本密钥平滑切换，提升安全性。","时间窗口模式：灵活设置签名有效期，平衡安全和可用性。","参数排序模式：所有签名参数统一排序，确保前后端一致。"]}});export{D as default};
