var B=Object.defineProperty;var O=(h,s,t)=>s in h?B(h,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[s]=t;var D=(h,s,t)=>O(h,typeof s!="symbol"?s+"":s,t);import{j as e,r as N}from"./index-Bi_r7QuH.js";import{C as F}from"./ComponentTemplate-C5EWLtXX.js";class ${constructor(s={}){D(this,"config");D(this,"data",[]);D(this,"aggregatedData",new Map);D(this,"listeners",new Set);D(this,"aggregationTimer");D(this,"lastAggregation",0);this.config={enabled:!0,sampleRate:1,retentionDays:30,aggregationInterval:6e4,enableRealTime:!0,enableGeolocation:!1,enableUserTracking:!0,enablePerformanceTracking:!0,customDimensions:[],excludePatterns:[],includePatterns:[],...s},this.config.enabled&&this.startAggregation()}track(s){if(!this.config.enabled||!this.shouldTrack(s)||Math.random()>this.config.sampleRate)return;const t={id:this.generateId(),timestamp:Date.now(),url:"",method:"GET",statusCode:200,duration:0,size:0,...s};this.enrichData(t),this.data.push(t),this.cleanupOldData(),this.config.enableRealTime&&this.notifyListeners(this.calculateMetrics())}trackBatch(s){s.forEach(t=>this.track(t))}getMetrics(s){const t=this.filterData(s);return this.calculateMetrics(t)}getTimeSeries(s,t=36e5,r){const o=this.filterData(r),c=new Map;return o.forEach(l=>{const m=Math.floor(l.timestamp/t)*t;c.has(m)||c.set(m,[]),c.get(m).push(l)}),Array.from(c.entries()).sort(([l],[m])=>l-m).map(([l,m])=>{const x=this.calculateMetrics(m);return{timestamp:l,value:this.extractMetricValue(x,s)}})}getTopEndpoints(s=10,t){const r=this.filterData(t),o=new Map;return r.forEach(c=>{const l=this.normalizeEndpoint(c.url),m=o.get(l)||{count:0,totalTime:0,errors:0,totalSize:0};m.count++,m.totalTime+=c.duration,m.totalSize+=c.size,c.statusCode>=400&&m.errors++,o.set(l,m)}),Array.from(o.entries()).map(([c,l])=>({endpoint:c,count:l.count,avgTime:l.totalTime/l.count,errorRate:l.errors/l.count*100,totalSize:l.totalSize})).sort((c,l)=>l.count-c.count).slice(0,s)}getErrorAnalysis(s){const t=this.filterData(s),r=t.filter(g=>g.statusCode>=400),o=t.length,c={};r.forEach(g=>{c[g.statusCode]=(c[g.statusCode]||0)+1});const l=new Map;t.forEach(g=>{const j=this.normalizeEndpoint(g.url),u=l.get(j)||{count:0,total:0};u.total++,g.statusCode>=400&&u.count++,l.set(j,u)});const m=Array.from(l.entries()).map(([g,j])=>({endpoint:g,count:j.count,rate:j.count/j.total*100})).filter(g=>g.count>0).sort((g,j)=>j.count-g.count),x=this.getTimeSeries("errorRate",36e5,s).map(g=>({timestamp:g.timestamp,count:Math.round(g.value*o/100)})),v=new Map;r.forEach(g=>{if(g.error){const j=g.error.substring(0,100);v.set(j,(v.get(j)||0)+1)}});const b=Array.from(v.entries()).map(([g,j])=>({error:g,count:j})).sort((g,j)=>j.count-g.count).slice(0,10);return{totalErrors:r.length,errorRate:o>0?r.length/o*100:0,errorsByStatus:c,errorsByEndpoint:m,errorTrends:x,commonErrors:b}}getPerformanceAnalysis(s){const t=this.filterData(s),r=t.map(u=>u.duration).sort((u,n)=>u-n),o=r.length>0?r.reduce((u,n)=>u+n,0)/r.length:0,c=r.length>0?r[Math.floor(r.length/2)]:0,l=r.length>0?r[Math.floor(r.length*.95)]:0,m=r.length>0?r[Math.floor(r.length*.99)]:0,x=new Map;t.forEach(u=>{const n=this.normalizeEndpoint(u.url);x.has(n)||x.set(n,[]),x.get(n).push(u.duration)});const v=Array.from(x.entries()).map(([u,n])=>{const f=n.sort((T,E)=>T-E);return{endpoint:u,avgTime:n.reduce((T,E)=>T+E,0)/n.length,p95Time:f[Math.floor(f.length*.95)]||0}}).sort((u,n)=>n.avgTime-u.avgTime).slice(0,10),b=this.getTimeSeries("avgResponseTime",36e5,s).map(u=>({timestamp:u.timestamp,avgTime:u.value,p95Time:0})),j=[{min:0,max:1024,label:"< 1KB"},{min:1024,max:10240,label:"1-10KB"},{min:10240,max:102400,label:"10-100KB"},{min:102400,max:1048576,label:"100KB-1MB"},{min:1048576,max:1/0,label:"> 1MB"}].map(u=>{const n=t.filter(f=>f.size>=u.min&&f.size<u.max);return{range:u.label,count:n.length,avgTime:n.length>0?n.reduce((f,T)=>f+T.duration,0)/n.length:0}});return{avgResponseTime:o,medianResponseTime:c,p95ResponseTime:l,p99ResponseTime:m,slowestEndpoints:v,performanceTrends:b,sizeDistribution:j}}getUserAnalysis(s){const t=this.filterData(s);new Set(t.map(n=>n.userId).filter(Boolean));const r=new Map;t.forEach(n=>{if(!n.userId)return;const f=r.get(n.userId)||{requests:0,totalTime:0,firstSeen:n.timestamp,lastSeen:n.timestamp,region:n.region,device:n.device,browser:n.browser};f.requests++,f.totalTime+=n.duration,f.firstSeen=Math.min(f.firstSeen,n.timestamp),f.lastSeen=Math.max(f.lastSeen,n.timestamp),r.set(n.userId,f)});const o={};r.forEach(n=>{n.region&&(o[n.region]=(o[n.region]||0)+1)});const c={};r.forEach(n=>{n.device&&(c[n.device]=(c[n.device]||0)+1)});const l={};r.forEach(n=>{n.browser&&(l[n.browser]=(l[n.browser]||0)+1)});const m=Array.from(r.entries()).map(([n,f])=>({userId:n,requests:f.requests,avgTime:f.totalTime/f.requests})).sort((n,f)=>f.requests-n.requests).slice(0,10),x=[{step:"首次访问",users:r.size,dropRate:0},{step:"第二次访问",users:Math.floor(r.size*.6),dropRate:40},{step:"活跃用户",users:Math.floor(r.size*.3),dropRate:50},{step:"忠实用户",users:Math.floor(r.size*.1),dropRate:67}],v=Date.now(),b=24*60*60*1e3,g=Array.from(r.values()).filter(n=>v-n.lastSeen<b).length,j=7*b,u=Array.from(r.values()).filter(n=>v-n.firstSeen<j).length;return{totalUsers:r.size,activeUsers:g,newUsers:u,usersByRegion:o,usersByDevice:c,usersByBrowser:l,topUsers:m,userJourney:x}}export(s="json",t){const r=this.filterData(t);switch(s){case"json":return JSON.stringify({data:r,metrics:this.calculateMetrics(r),exportTime:new Date().toISOString()},null,2);case"csv":const o=["timestamp","url","method","statusCode","duration","size","userId","region","device"],c=r.map(l=>[new Date(l.timestamp).toISOString(),l.url,l.method,l.statusCode,l.duration,l.size,l.userId||"",l.region||"",l.device||""]);return[o,...c].map(l=>l.join(",")).join(`
`);default:return JSON.stringify(r,null,2)}}generateReport(s){const t=this.getMetrics(s),r=this.getPerformanceAnalysis(s),o=this.getErrorAnalysis(s),c=this.getUserAnalysis(s),l=this.getTopEndpoints(10,s),m=this.generateRecommendations(t,r,o);return{summary:t,performance:r,errors:o,users:c,topEndpoints:l,recommendations:m}}generateRecommendations(s,t,r){const o=[];return t.avgResponseTime>1e3&&o.push("平均响应时间较高，建议优化慢查询和缓存策略"),t.p95ResponseTime>3e3&&o.push("95%响应时间过长，需要优化最慢的请求"),r.errorRate>5&&o.push("错误率较高，需要重点关注错误处理和系统稳定性"),s.cacheHitRate<50&&o.push("缓存命中率较低，建议优化缓存策略"),s.throughput>1e3&&o.push("请求量较大，建议考虑负载均衡和水平扩展"),o}filterData(s){var o,c,l,m;if(!s)return this.data;let t=this.data;const r=this.getTimeRangeMs(s.timeRange);if(r){const x=s.startTime||Date.now()-r,v=s.endTime||Date.now();t=t.filter(b=>b.timestamp>=x&&b.timestamp<=v)}return(o=s.methods)!=null&&o.length&&(t=t.filter(x=>s.methods.includes(x.method))),(c=s.statusCodes)!=null&&c.length&&(t=t.filter(x=>s.statusCodes.includes(x.statusCode))),(l=s.endpoints)!=null&&l.length&&(t=t.filter(x=>s.endpoints.some(v=>x.url.includes(v)))),(m=s.userIds)!=null&&m.length&&(t=t.filter(x=>x.userId&&s.userIds.includes(x.userId))),s.minDuration!==void 0&&(t=t.filter(x=>x.duration>=s.minDuration)),s.maxDuration!==void 0&&(t=t.filter(x=>x.duration<=s.maxDuration)),s.excludeErrors&&(t=t.filter(x=>x.statusCode<400)),s.onlyCached&&(t=t.filter(x=>x.cached)),t}calculateMetrics(s=this.data){var C,A;if(s.length===0)return this.getEmptyMetrics();const t=s.length,r=s.filter(a=>a.statusCode<400).length,o=t-r,c=s.filter(a=>a.cached).length,l=new Set(s.map(a=>a.userId).filter(Boolean)).size,m=s.map(a=>a.duration).sort((a,p)=>a-p),x=m.reduce((a,p)=>a+p,0)/m.length,v=m[Math.floor(m.length*.95)]||0,b=m[Math.floor(m.length*.99)]||0,g=Math.max(((C=s[s.length-1])==null?void 0:C.timestamp)-((A=s[0])==null?void 0:A.timestamp),1e3),j=t/g*1e3,u=s.reduce((a,p)=>a+p.size,0),n=new Map;s.forEach(a=>{const p=this.normalizeEndpoint(a.url),y=n.get(p)||{count:0,totalTime:0};y.count++,y.totalTime+=a.duration,n.set(p,y)});const f=Array.from(n.entries()).map(([a,p])=>({endpoint:a,count:p.count,avgTime:p.totalTime/p.count})).sort((a,p)=>p.count-a.count).slice(0,10),T={};s.filter(a=>a.statusCode>=400).forEach(a=>{const p=`${Math.floor(a.statusCode/100)}xx`;T[p]=(T[p]||0)+1});const i=[{min:0,max:100,label:"< 100ms"},{min:100,max:500,label:"100-500ms"},{min:500,max:1e3,label:"500ms-1s"},{min:1e3,max:3e3,label:"1-3s"},{min:3e3,max:1/0,label:"> 3s"}].map(a=>({range:a.label,count:s.filter(p=>p.duration>=a.min&&p.duration<a.max).length})),d={};s.forEach(a=>{a.region&&(d[a.region]=(d[a.region]||0)+1)});const R={};s.forEach(a=>{a.device&&(R[a.device]=(R[a.device]||0)+1)});const M={};s.forEach(a=>{a.browser&&(M[a.browser]=(M[a.browser]||0)+1)});const w=new Map;s.forEach(a=>{const p=new Date(a.timestamp).getHours(),y=w.get(p)||{requests:0,totalTime:0};y.requests++,y.totalTime+=a.duration,w.set(p,y)});const k=Array.from({length:24},(a,p)=>{const y=w.get(p)||{requests:0,totalTime:0};return{hour:p,requests:y.requests,avgTime:y.requests>0?y.totalTime/y.requests:0}}),S={};return s.forEach(a=>{S[a.statusCode]=(S[a.statusCode]||0)+1}),{totalRequests:t,successRate:r/t*100,errorRate:o/t*100,avgResponseTime:x,p95ResponseTime:v,p99ResponseTime:b,throughput:j,totalDataTransfer:u,cacheHitRate:c>0?c/t*100:0,uniqueUsers:l,topEndpoints:f,errorsByType:T,responseTimeDistribution:i,geographicDistribution:d,deviceDistribution:R,browserDistribution:M,hourlyTraffic:k,statusCodeDistribution:S}}getEmptyMetrics(){return{totalRequests:0,successRate:0,errorRate:0,avgResponseTime:0,p95ResponseTime:0,p99ResponseTime:0,throughput:0,totalDataTransfer:0,cacheHitRate:0,uniqueUsers:0,topEndpoints:[],errorsByType:{},responseTimeDistribution:[],geographicDistribution:{},deviceDistribution:{},browserDistribution:{},hourlyTraffic:[],statusCodeDistribution:{}}}getTimeRangeMs(s){switch(s){case"1h":return 60*60*1e3;case"6h":return 6*60*60*1e3;case"24h":return 24*60*60*1e3;case"7d":return 7*24*60*60*1e3;case"30d":return 30*24*60*60*1e3;default:return null}}normalizeEndpoint(s){return s.split("?")[0].split("#")[0].replace(/\/\d+/g,"/:id")}extractMetricValue(s,t){const r=s[t];return typeof r=="number"?r:0}shouldTrack(s){return!s.url||this.config.excludePatterns.some(t=>t.test(s.url))?!1:this.config.includePatterns.length>0?this.config.includePatterns.some(t=>t.test(s.url)):!0}enrichData(s){if(s.userAgent){const t=this.parseUserAgent(s.userAgent);s.browser=t.browser,s.os=t.os,s.device=t.device}s.ip&&!s.region&&(s.region=this.getRegionFromIP(s.ip))}parseUserAgent(s){let t="Unknown",r="Unknown",o="Desktop";return s.includes("Chrome")?t="Chrome":s.includes("Firefox")?t="Firefox":s.includes("Safari")?t="Safari":s.includes("Edge")&&(t="Edge"),s.includes("Windows")?r="Windows":s.includes("Mac")?r="macOS":s.includes("Linux")?r="Linux":s.includes("Android")?r="Android":s.includes("iOS")&&(r="iOS"),s.includes("Mobile")||s.includes("Android")||s.includes("iPhone")?o="Mobile":(s.includes("Tablet")||s.includes("iPad"))&&(o="Tablet"),{browser:t,os:r,device:o}}getRegionFromIP(s){const t=["北京","上海","广州","深圳","杭州","成都","武汉","西安"],r=s.split(".").reduce((o,c)=>o+parseInt(c,10),0);return t[r%t.length]}cleanupOldData(){const s=Date.now()-this.config.retentionDays*24*60*60*1e3;this.data=this.data.filter(t=>t.timestamp>s)}startAggregation(){this.aggregationTimer=setInterval(()=>{this.aggregate()},this.config.aggregationInterval)}aggregate(){const s=Date.now(),t=Math.floor(s/this.config.aggregationInterval).toString(),r=this.data.filter(o=>o.timestamp>this.lastAggregation);if(r.length>0){const o=this.calculateMetrics(r);this.aggregatedData.set(t,o),this.lastAggregation=s}}notifyListeners(s){this.listeners.forEach(t=>{try{t(s)}catch(r){console.error("Analytics listener error:",r)}})}generateId(){return`${Date.now()}_${Math.random().toString(36).substr(2,9)}`}addListener(s){this.listeners.add(s)}removeListener(s){this.listeners.delete(s)}updateConfig(s){this.config={...this.config,...s},!this.config.enabled&&this.aggregationTimer?(clearInterval(this.aggregationTimer),this.aggregationTimer=void 0):this.config.enabled&&!this.aggregationTimer&&this.startAggregation()}clear(){this.data=[],this.aggregatedData.clear(),this.lastAggregation=0}destroy(){this.aggregationTimer&&clearInterval(this.aggregationTimer),this.clear(),this.listeners.clear()}}const L=()=>{const[h]=N.useState(()=>new $({enabled:!0,sampleRate:1,retentionDays:7,aggregationInterval:5e3,enableRealTime:!0,enableUserTracking:!0,enablePerformanceTracking:!0})),[s,t]=N.useState(h.getMetrics()),[r,o]=N.useState({timeRange:"24h",excludeErrors:!1}),[c,l]=N.useState(!1),[m,x]=N.useState("overview"),v=N.useRef(),b=N.useCallback(()=>{const i=h.getMetrics(r);t(i)},[h,r]);N.useEffect(()=>{const i=d=>{t(d)};return h.addListener(i),b(),()=>{h.removeListener(i)}},[h,b]);const g=N.useCallback(()=>{const i=["/api/users","/api/posts","/api/comments","/api/products","/api/orders","/api/auth/login","/api/auth/logout","/api/search","/api/upload","/api/download","/api/settings","/api/profile"],d=["GET","POST","PUT","DELETE"],R=[200,201,400,401,403,404,500],M=["北京","上海","广州","深圳","杭州"],w=["Desktop","Mobile","Tablet"],k=["Chrome","Firefox","Safari","Edge"],S=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36","Mozilla/5.0 (iPhone; CPU iPhone OS 14_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.1.1 Mobile/15E148 Safari/604.1"],C=i[Math.floor(Math.random()*i.length)],A=d[Math.floor(Math.random()*d.length)],a=R[Math.floor(Math.random()*R.length)],p=M[Math.floor(Math.random()*M.length)],y=w[Math.floor(Math.random()*w.length)],I=k[Math.floor(Math.random()*k.length)],P=S[Math.floor(Math.random()*S.length)],U=(a>=400?2e3:200)+Math.floor(Math.random()*1e3),z=Math.floor(Math.random()*1e5)+1e3;h.track({url:C,method:A,statusCode:a,duration:U,size:z,userId:`user_${Math.floor(Math.random()*100)}`,sessionId:`sess_${Math.random().toString(36).substr(2,8)}`,ip:`192.168.1.${Math.floor(Math.random()*255)}`,userAgent:P,region:p,device:y,browser:I,cached:Math.random()>.7,retryCount:a>=400?Math.floor(Math.random()*3):0,error:a>=400?`HTTP ${a} Error`:void 0})},[h]),j=N.useCallback(()=>{c?(v.current&&clearInterval(v.current),l(!1)):(v.current=setInterval(g,500),l(!0))},[c,g]),u=N.useCallback(()=>{h.clear(),b()},[h,b]),n=N.useCallback(i=>{const d=h.export(i,r),R=new Blob([d],{type:"text/plain"}),M=URL.createObjectURL(R),w=document.createElement("a");w.href=M,w.download=`analytics.${i}`,w.click(),URL.revokeObjectURL(M)},[h,r]);N.useEffect(()=>()=>{v.current&&clearInterval(v.current),h.destroy()},[h]);const f=i=>i>=1e6?`${(i/1e6).toFixed(1)}M`:i>=1e3?`${(i/1e3).toFixed(1)}K`:i.toString(),T=i=>i>=1024*1024?`${(i/(1024*1024)).toFixed(1)}MB`:i>=1024?`${(i/1024).toFixed(1)}KB`:`${i}B`,E=i=>i>=200&&i<300?"text-green-600 bg-green-100":i>=300&&i<400?"text-blue-600 bg-blue-100":i>=400&&i<500?"text-yellow-600 bg-yellow-100":"text-red-600 bg-red-100";return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg border",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"请求分析演示"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"操作控制"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:j,className:`w-full px-4 py-2 rounded-md text-white ${c?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700"}`,children:c?"停止生成":"开始生成"}),e.jsx("button",{onClick:u,className:"w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700",children:"清空数据"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"过滤器"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-1",children:"时间范围"}),e.jsxs("select",{value:r.timeRange,onChange:i=>o(d=>({...d,timeRange:i.target.value})),className:"w-full p-2 border border-gray-300 rounded-md text-sm",children:[e.jsx("option",{value:"1h",children:"1小时"}),e.jsx("option",{value:"6h",children:"6小时"}),e.jsx("option",{value:"24h",children:"24小时"}),e.jsx("option",{value:"7d",children:"7天"}),e.jsx("option",{value:"30d",children:"30天"})]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"excludeErrors",checked:r.excludeErrors,onChange:i=>o(d=>({...d,excludeErrors:i.target.checked})),className:"mr-2"}),e.jsx("label",{htmlFor:"excludeErrors",className:"text-sm text-gray-600",children:"排除错误请求"})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"导出"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>n("json"),className:"w-full px-3 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700",children:"导出 JSON"}),e.jsx("button",{onClick:()=>n("csv"),className:"w-full px-3 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700",children:"导出 CSV"})]})]})]}),e.jsxs("div",{className:"lg:col-span-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:f(s.totalRequests)}),e.jsx("div",{className:"text-sm text-blue-800",children:"总请求数"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[s.successRate.toFixed(1),"%"]}),e.jsx("div",{className:"text-sm text-green-800",children:"成功率"})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"text-2xl font-bold text-yellow-600",children:[Math.round(s.avgResponseTime),"ms"]}),e.jsx("div",{className:"text-sm text-yellow-800",children:"平均响应时间"})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:f(s.uniqueUsers)}),e.jsx("div",{className:"text-sm text-purple-800",children:"独立用户"})]})]}),e.jsx("div",{className:"border-b",children:e.jsx("nav",{className:"flex space-x-8",children:[{key:"overview",label:"概览"},{key:"performance",label:"性能"},{key:"errors",label:"错误"},{key:"users",label:"用户"}].map(i=>e.jsx("button",{onClick:()=>x(i.key),className:`py-2 px-1 border-b-2 font-medium text-sm ${m===i.key?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:i.label},i.key))})}),e.jsxs("div",{className:"min-h-96",children:[m==="overview"&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"热门端点"}),e.jsx("div",{className:"space-y-2",children:s.topEndpoints.slice(0,5).map((i,d)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:i.endpoint}),e.jsxs("div",{className:"text-xs text-gray-500",children:[i.count," 次请求"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium",children:[Math.round(i.avgTime),"ms"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"平均时间"})]})]},d))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"状态码分布"}),e.jsx("div",{className:"space-y-2",children:Object.entries(s.statusCodeDistribution).sort(([,i],[,d])=>d-i).slice(0,5).map(([i,d])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded",children:[e.jsx("span",{className:`px-2 py-1 text-xs rounded ${E(parseInt(i))}`,children:i}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium",children:d}),e.jsxs("div",{className:"text-xs text-gray-500",children:[(d/s.totalRequests*100).toFixed(1),"%"]})]})]},i))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"响应时间分布"}),e.jsx("div",{className:"space-y-2",children:s.responseTimeDistribution.map((i,d)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded",children:[e.jsx("span",{className:"text-sm",children:i.range}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium",children:i.count}),e.jsxs("div",{className:"text-xs text-gray-500",children:[s.totalRequests>0?(i.count/s.totalRequests*100).toFixed(1):0,"%"]})]})]},d))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"关键指标"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"错误率:"}),e.jsxs("span",{className:`text-sm font-medium ${s.errorRate>5?"text-red-600":"text-green-600"}`,children:[s.errorRate.toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"P95响应时间:"}),e.jsxs("span",{className:"text-sm font-medium",children:[Math.round(s.p95ResponseTime),"ms"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"P99响应时间:"}),e.jsxs("span",{className:"text-sm font-medium",children:[Math.round(s.p99ResponseTime),"ms"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"吞吐量:"}),e.jsxs("span",{className:"text-sm font-medium",children:[s.throughput.toFixed(1)," req/s"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"缓存命中率:"}),e.jsxs("span",{className:"text-sm font-medium",children:[s.cacheHitRate.toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"数据传输:"}),e.jsx("span",{className:"text-sm font-medium",children:T(s.totalDataTransfer)})]})]})]})]}),m==="performance"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"text-xl font-bold text-blue-600",children:[Math.round(s.avgResponseTime),"ms"]}),e.jsx("div",{className:"text-sm text-blue-800",children:"平均响应时间"})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"text-xl font-bold text-yellow-600",children:[Math.round(s.p95ResponseTime),"ms"]}),e.jsx("div",{className:"text-sm text-yellow-800",children:"P95响应时间"})]}),e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"text-xl font-bold text-red-600",children:[Math.round(s.p99ResponseTime),"ms"]}),e.jsx("div",{className:"text-sm text-red-800",children:"P99响应时间"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"最慢端点"}),e.jsx("div",{className:"space-y-2",children:h.getPerformanceAnalysis(r).slowestEndpoints.slice(0,5).map((i,d)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:i.endpoint}),e.jsxs("div",{className:"text-xs text-gray-500",children:["P95: ",Math.round(i.p95Time),"ms"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-red-600",children:[Math.round(i.avgTime),"ms"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"平均时间"})]})]},d))})]})]}),m==="errors"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-red-600",children:h.getErrorAnalysis(r).totalErrors}),e.jsx("div",{className:"text-sm text-red-800",children:"总错误数"})]}),e.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"text-xl font-bold text-orange-600",children:[h.getErrorAnalysis(r).errorRate.toFixed(1),"%"]}),e.jsx("div",{className:"text-sm text-orange-800",children:"错误率"})]}),e.jsxs("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-yellow-600",children:Object.keys(h.getErrorAnalysis(r).errorsByStatus).length}),e.jsx("div",{className:"text-sm text-yellow-800",children:"错误类型"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"错误状态码"}),e.jsx("div",{className:"space-y-2",children:Object.entries(h.getErrorAnalysis(r).errorsByStatus).sort(([,i],[,d])=>d-i).slice(0,5).map(([i,d])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded",children:[e.jsx("span",{className:`px-2 py-1 text-xs rounded ${E(parseInt(i))}`,children:i}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium",children:d}),e.jsx("div",{className:"text-xs text-gray-500",children:"错误次数"})]})]},i))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"错误端点"}),e.jsx("div",{className:"space-y-2",children:h.getErrorAnalysis(r).errorsByEndpoint.slice(0,5).map((i,d)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:i.endpoint}),e.jsxs("div",{className:"text-xs text-gray-500",children:[i.count," 次错误"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-red-600",children:[i.rate.toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"错误率"})]})]},d))})]})]})]}),m==="users"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-purple-600",children:h.getUserAnalysis(r).totalUsers}),e.jsx("div",{className:"text-sm text-purple-800",children:"总用户数"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-green-600",children:h.getUserAnalysis(r).activeUsers}),e.jsx("div",{className:"text-sm text-green-800",children:"活跃用户"})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-blue-600",children:h.getUserAnalysis(r).newUsers}),e.jsx("div",{className:"text-sm text-blue-800",children:"新用户"})]}),e.jsxs("div",{className:"bg-indigo-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-indigo-600",children:Object.keys(h.getUserAnalysis(r).usersByRegion).length}),e.jsx("div",{className:"text-sm text-indigo-800",children:"覆盖地区"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"地区分布"}),e.jsx("div",{className:"space-y-2",children:Object.entries(h.getUserAnalysis(r).usersByRegion).sort(([,i],[,d])=>d-i).slice(0,5).map(([i,d])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded",children:[e.jsx("span",{className:"text-sm",children:i}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium",children:d}),e.jsx("div",{className:"text-xs text-gray-500",children:"用户数"})]})]},i))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"设备分布"}),e.jsx("div",{className:"space-y-2",children:Object.entries(h.getUserAnalysis(r).usersByDevice).sort(([,i],[,d])=>d-i).slice(0,5).map(([i,d])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded",children:[e.jsx("span",{className:"text-sm",children:i}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium",children:d}),e.jsx("div",{className:"text-xs text-gray-500",children:"用户数"})]})]},i))})]})]})]})]})]})]})]})})},K={title:"RequestAnalytics 实现",language:"typescript",code:`// 创建分析器实例
const analytics = new RequestAnalytics({
  enabled: true,
  sampleRate: 1.0, // 100% 采样
  retentionDays: 30,
  aggregationInterval: 60000, // 1分钟聚合
  enableRealTime: true,
  enableUserTracking: true,
  enablePerformanceTracking: true
});

// 记录请求数据
analytics.track({
  url: '/api/users',
  method: 'GET',
  statusCode: 200,
  duration: 150,
  size: 2048,
  userId: 'user_123',
  sessionId: 'sess_abc',
  ip: '192.168.1.100',
  userAgent: 'Mozilla/5.0...',
  region: '北京',
  device: 'Desktop',
  browser: 'Chrome',
  cached: false
});

// 获取分析指标
const metrics = analytics.getMetrics({
  timeRange: '24h',
  excludeErrors: false
});

// 获取性能分析
const performance = analytics.getPerformanceAnalysis();
console.log('平均响应时间:', performance.avgResponseTime);
console.log('P95响应时间:', performance.p95ResponseTime);

// 获取错误分析
const errors = analytics.getErrorAnalysis();
console.log('错误率:', errors.errorRate);
console.log('错误分布:', errors.errorsByStatus);

// 获取用户分析
const users = analytics.getUserAnalysis();
console.log('总用户数:', users.totalUsers);
console.log('活跃用户:', users.activeUsers);

// 生成完整报告
const report = analytics.generateReport();
console.log('分析报告:', report);

// 导出数据
const jsonData = analytics.export('json');
const csvData = analytics.export('csv');`,highlights:[1,11,25,31,37,43,49,55]},J=()=>{const h=e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 p-6 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-900 mb-2",children:"核心概念"}),e.jsxs("ul",{className:"space-y-2 text-blue-800",children:[e.jsxs("li",{children:["• ",e.jsx("strong",{children:"数据收集"}),"：自动收集请求的各种指标数据"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"实时分析"}),"：提供实时的性能和错误分析"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"多维度统计"}),"：支持时间、地区、设备等多维度分析"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"智能聚合"}),"：自动聚合和压缩历史数据"]})]})]}),e.jsxs("div",{className:"bg-green-50 p-6 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-green-900 mb-2",children:"主要优势"}),e.jsxs("ul",{className:"space-y-2 text-green-800",children:[e.jsxs("li",{children:["• ",e.jsx("strong",{children:"全面监控"}),"：覆盖性能、错误、用户等各个维度"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"实时反馈"}),"：提供实时的分析结果和告警"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"灵活过滤"}),"：支持多种过滤条件和时间范围"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"数据导出"}),"：支持多种格式的数据导出"]})]})]}),e.jsxs("div",{className:"bg-yellow-50 p-6 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-yellow-900 mb-2",children:"适用场景"}),e.jsxs("ul",{className:"space-y-2 text-yellow-800",children:[e.jsxs("li",{children:["• ",e.jsx("strong",{children:"性能监控"}),"：监控API响应时间和吞吐量"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"错误分析"}),"：分析错误模式和趋势"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"用户行为"}),"：分析用户访问模式和地理分布"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"容量规划"}),"：基于历史数据进行容量规划"]})]})]}),e.jsxs("div",{className:"bg-red-50 p-6 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-red-900 mb-2",children:"注意事项"}),e.jsxs("ul",{className:"space-y-2 text-red-800",children:[e.jsxs("li",{children:["• ",e.jsx("strong",{children:"数据隐私"}),"：注意用户数据的隐私保护"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"存储成本"}),"：合理设置数据保留期限"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"采样策略"}),"：高流量场景下使用采样降低开销"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"性能影响"}),"：避免分析逻辑影响主业务性能"]})]})]})]}),s=[{title:"基础分析演示",component:e.jsx(L,{}),description:"演示请求分析的基本功能，包括数据收集、指标计算、多维度分析等。",observationPoints:["观察实时生成的请求数据如何被收集和分析","注意不同时间范围和过滤条件对分析结果的影响","查看性能、错误、用户等不同维度的分析结果","体验数据导出功能的便利性"],keyPoints:["RequestAnalytics 提供全面的请求分析能力","支持实时数据收集和分析","提供多维度的统计和过滤功能","支持数据导出和报告生成"],commonTraps:["数据量过大导致的性能问题","采样率设置不当影响分析准确性","过滤条件设置错误导致数据缺失","忽略数据隐私和安全问题"],solutions:["合理设置采样率和数据保留期","使用异步处理避免阻塞主线程","实施数据脱敏和访问控制","定期清理和归档历史数据"],importantTips:["分析器会自动聚合数据以提高查询性能","实时分析功能可能会增加系统负载","导出功能支持JSON和CSV格式","过滤器可以组合使用以获得精确的分析结果"],codeExample:K}],t={concepts:["请求分析是通过收集、处理和分析HTTP请求数据来获得业务洞察的过程","分析维度包括性能指标、错误统计、用户行为、地理分布等","实时分析能够快速发现问题并提供及时反馈","历史数据分析有助于发现趋势和模式"],steps:["创建RequestAnalytics实例并配置相关参数","在请求处理过程中调用track方法记录数据","使用getMetrics等方法获取分析结果","根据需要设置过滤条件和时间范围","导出数据或生成报告用于进一步分析"],tips:["合理设置采样率以平衡准确性和性能","定期清理过期数据以控制存储成本","使用异步处理避免影响主业务流程","实施适当的数据脱敏和访问控制","结合告警机制实现主动监控"]},r={questions:[{question:"请求分析系统的核心组件有哪些？",answer:"核心组件包括：1) 数据收集器 - 负责收集请求数据；2) 数据处理器 - 负责数据清洗和转换；3) 分析引擎 - 负责指标计算和统计；4) 存储系统 - 负责数据持久化；5) 查询接口 - 负责数据检索和过滤；6) 可视化组件 - 负责数据展示。"},{question:"如何处理大流量场景下的数据收集？",answer:"大流量场景下可以采用：1) 采样策略 - 只收集部分请求数据；2) 异步处理 - 使用队列缓冲数据；3) 批量写入 - 减少I/O操作频率；4) 数据压缩 - 减少存储空间；5) 分布式存储 - 水平扩展存储能力；6) 缓存机制 - 提高查询性能。"},{question:"如何设计有效的性能指标？",answer:"有效的性能指标应该：1) 响应时间指标 - 平均值、中位数、P95、P99等；2) 吞吐量指标 - QPS、TPS等；3) 错误率指标 - 按状态码、端点分类；4) 资源使用指标 - CPU、内存、网络等；5) 业务指标 - 转化率、用户满意度等；6) 趋势指标 - 同比、环比变化。"},{question:"如何实现实时分析和告警？",answer:"实时分析和告警可以通过：1) 流式处理 - 使用流处理框架处理实时数据；2) 滑动窗口 - 计算时间窗口内的指标；3) 阈值监控 - 设置告警阈值和规则；4) 事件驱动 - 基于事件触发告警；5) 多级告警 - 设置不同级别的告警；6) 告警聚合 - 避免告警风暴。"}],keyPoints:["数据收集的完整性和准确性是分析的基础","采样策略需要在性能和准确性之间找到平衡","多维度分析能够提供更全面的业务洞察","实时分析和历史分析各有其适用场景","数据隐私和安全是分析系统的重要考虑因素"]},o={dos:["设计合理的数据模型和存储结构","实施适当的采样和聚合策略","提供灵活的查询和过滤功能","建立完善的数据治理流程","实现数据的可视化和报表功能","建立告警和监控机制","定期进行数据备份和归档","保护用户数据隐私和安全"],donts:["不要收集过多不必要的数据","不要忽略数据质量和一致性","不要在主业务流程中进行重计算","不要忽略系统的可扩展性","不要暴露敏感的用户信息","不要忽略数据的生命周期管理","不要过度依赖实时分析","不要忽略分析结果的准确性验证"],patterns:["事件驱动模式：基于事件触发数据收集和分析","管道模式：构建数据处理管道","观察者模式：监听数据变化并触发分析","策略模式：支持不同的分析策略","装饰器模式：增强数据收集功能","工厂模式：创建不同类型的分析器","建造者模式：构建复杂的查询条件","适配器模式：适配不同的数据源"]};return e.jsx(F,{title:"请求分析 (Request Analytics)",description:"实现全面的请求数据收集、分析和可视化功能，支持性能监控、错误分析、用户行为分析等多个维度。",overview:h,examples:s,tutorial:t,interview:r,bestPractices:o})};export{J as default};
