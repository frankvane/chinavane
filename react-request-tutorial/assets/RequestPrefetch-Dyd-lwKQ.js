var I=Object.defineProperty;var S=(i,e,s)=>e in i?I(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s;var h=(i,e,s)=>S(i,typeof e!="symbol"?e+"":e,s);import{r as c,j as t}from"./index-C7SuDyTR.js";import{C as k}from"./ComponentTemplate-BzrYXZsv.js";class E{constructor(){h(this,"items",new Map);h(this,"loadingQueue",new Set);h(this,"observers",new Map);h(this,"hoverTimers",new Map);h(this,"listeners",new Set);h(this,"stats",{total:0,success:0,error:0,cached:0,avgLoadTime:0});this.setupIdleCallback()}async prefetch(e,s="immediate",r={},l){const d={...{maxConcurrent:3,timeout:5e3,retryCount:2,retryDelay:1e3,priority:1,cacheTime:3e5,staleTime:6e4,enabled:!0},...r},n=this.generateId(e);if(this.items.has(n))return n;const x={id:n,url:e,options:l,config:d,status:"pending",timestamp:Date.now(),retryCount:0};switch(this.items.set(n,x),this.stats.total++,s){case"immediate":await this.executeImmediate(n);break;case"idle":this.scheduleIdle(n);break}return n}async executeImmediate(e){const s=this.items.get(e);!s||this.loadingQueue.size>=s.config.maxConcurrent||await this.loadItem(s)}scheduleIdle(e){"requestIdleCallback"in window?window.requestIdleCallback(()=>this.executeImmediate(e)):setTimeout(()=>this.executeImmediate(e),100)}setupHoverPrefetch(e,s,r=200,l){const o=()=>{const n=setTimeout(()=>{this.prefetch(s,"hover",l)},r);this.hoverTimers.set(s,n)},d=()=>{const n=this.hoverTimers.get(s);n&&(clearTimeout(n),this.hoverTimers.delete(s))};return e.addEventListener("mouseenter",o),e.addEventListener("mouseleave",d),()=>{e.removeEventListener("mouseenter",o),e.removeEventListener("mouseleave",d);const n=this.hoverTimers.get(s);n&&(clearTimeout(n),this.hoverTimers.delete(s))}}setupVisibilityPrefetch(e,s,r){const l=new IntersectionObserver(o=>{o.forEach(d=>{d.isIntersecting&&this.prefetch(s,"visible",r)})});return l.observe(e),this.observers.set(s,l),()=>{l.disconnect(),this.observers.delete(s)}}async trigger(e){const s=this.items.get(e);s&&await this.loadItem(s)}getData(e){const s=this.generateId(e),r=this.items.get(s);if(!r)return null;const l=Date.now(),o=l-r.timestamp>r.config.staleTime;return l-r.timestamp>r.config.cacheTime?(this.items.delete(s),null):(o&&r.config.enabled&&this.executeImmediate(s),r.status==="success"&&r.data||null)}isLoading(e){const s=this.generateId(e);return this.loadingQueue.has(s)}getItems(){return Array.from(this.items.values())}clear(e){if(e){const s=this.generateId(e);this.items.delete(s),this.loadingQueue.delete(s)}else this.items.clear(),this.loadingQueue.clear();this.notifyListeners()}clearExpired(){const e=Date.now(),s=[];this.items.forEach((r,l)=>{e-r.timestamp>r.config.cacheTime&&s.push(l)}),s.forEach(r=>{this.items.delete(r),this.loadingQueue.delete(r)}),s.length>0&&this.notifyListeners()}getStats(){const e=Array.from(this.items.values()),s=e.filter(r=>r.loadTime).map(r=>r.loadTime);return{...this.stats,cached:e.filter(r=>r.status==="success").length,avgLoadTime:s.length>0?Math.round(s.reduce((r,l)=>r+l,0)/s.length):0}}resetStats(){this.stats={total:0,success:0,error:0,cached:0,avgLoadTime:0}}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}destroy(){this.items.clear(),this.loadingQueue.clear(),this.observers.forEach(e=>e.disconnect()),this.observers.clear(),this.hoverTimers.forEach(e=>clearTimeout(e)),this.hoverTimers.clear(),this.listeners.clear()}async loadItem(e){if(this.loadingQueue.has(e.id))return;this.loadingQueue.add(e.id),e.status="loading";const s=Date.now();this.notifyListeners();try{const r=new AbortController,l=setTimeout(()=>r.abort(),e.config.timeout),o=await fetch(e.url,{...e.options,signal:r.signal});if(clearTimeout(l),!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const d=await o.json();e.status="success",e.data=d,e.loadTime=Date.now()-s,e.timestamp=Date.now(),this.stats.success++}catch(r){if(e.error=r,e.retryCount<e.config.retryCount){e.retryCount++,setTimeout(()=>{this.loadingQueue.delete(e.id),this.loadItem(e)},e.config.retryDelay*Math.pow(2,e.retryCount));return}e.status="error",this.stats.error++}finally{this.loadingQueue.delete(e.id),this.notifyListeners()}}setupIdleCallback(){if("requestIdleCallback"in window){const e=()=>{this.clearExpired(),window.requestIdleCallback(e,{timeout:5e3})};window.requestIdleCallback(e)}else setInterval(()=>this.clearExpired(),3e4)}generateId(e){return btoa(e).replace(/[^a-zA-Z0-9]/g,"")}notifyListeners(){const e=Array.from(this.items.values());this.listeners.forEach(s=>{try{s(e)}catch(r){console.error("Prefetch listener error:",r)}})}}const L=()=>{const[i]=c.useState(()=>new E),[e,s]=c.useState([]),[r,l]=c.useState(i.getStats()),[o,d]=c.useState("immediate"),[n,x]=c.useState("https://jsonplaceholder.typicode.com/posts/1"),[p,b]=c.useState(!1),g=c.useRef(null),f=c.useRef(null),u=c.useCallback(()=>{l(i.getStats())},[i]);c.useEffect(()=>{const a=T=>{s(T)};i.addListener(a),s(i.getItems());const m=setInterval(u,1e3);return()=>{i.removeListener(a),clearInterval(m)}},[i,u]),c.useEffect(()=>{if(g.current)return i.setupHoverPrefetch(g.current,"https://jsonplaceholder.typicode.com/posts/2",300)},[i]),c.useEffect(()=>{if(f.current)return i.setupVisibilityPrefetch(f.current,"https://jsonplaceholder.typicode.com/posts/3")},[i]);const y=c.useCallback(async()=>{if(n){b(!0);try{await i.prefetch(n,o,{timeout:5e3,retryCount:2,cacheTime:5*60*1e3}),u()}catch(a){alert(`预取失败: ${a instanceof Error?a.message:"未知错误"}`)}finally{b(!1)}}},[i,n,o,u]),v=c.useCallback(a=>{const m=i.getData(a);alert(m?`获取到数据: ${JSON.stringify(m,null,2)}`:"没有可用的预取数据")},[i]),j=c.useCallback(()=>{i.clear(),u()},[i,u]),w=c.useCallback(()=>{i.resetStats(),u()},[i,u]);c.useEffect(()=>()=>i.destroy(),[i]);const N=a=>{switch(a){case"success":return"text-green-600";case"error":return"text-red-600";case"loading":return"text-blue-600";default:return"text-gray-600"}},C=a=>{switch(a){case"success":return"bg-green-100";case"error":return"bg-red-100";case"loading":return"bg-blue-100";default:return"bg-gray-100"}};return t.jsx("div",{className:"space-y-4",children:t.jsxs("div",{className:"bg-white p-6 rounded-lg border",children:[t.jsx("h3",{className:"text-lg font-semibold mb-4",children:"预取策略演示"}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"手动预取"}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("input",{type:"text",value:n,onChange:a=>x(a.target.value),placeholder:"请求URL",className:"w-full p-2 border border-gray-300 rounded-md"}),t.jsxs("select",{value:o,onChange:a=>d(a.target.value),className:"w-full p-2 border border-gray-300 rounded-md",children:[t.jsx("option",{value:"immediate",children:"立即预取"}),t.jsx("option",{value:"idle",children:"空闲预取"}),t.jsx("option",{value:"manual",children:"手动预取"})]}),t.jsx("button",{onClick:y,disabled:p||!n,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400",children:p?"预取中...":"开始预取"})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"悬停预取演示"}),t.jsxs("div",{ref:g,className:"p-4 border-2 border-dashed border-gray-300 rounded-md text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50",children:["悬停此区域300ms后触发预取",t.jsx("br",{}),t.jsx("span",{className:"text-sm text-gray-500",children:"URL: /posts/2"})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"可见性预取演示"}),t.jsxs("div",{className:"h-32 overflow-y-auto border border-gray-300 rounded-md",children:[t.jsx("div",{className:"h-20 bg-gray-100 flex items-center justify-center",children:"滚动到下方触发预取"}),t.jsx("div",{ref:f,className:"h-20 bg-yellow-100 flex items-center justify-center",children:"可见时触发预取 (/posts/3)"}),t.jsx("div",{className:"h-20 bg-gray-100 flex items-center justify-center",children:"底部内容"})]})]}),t.jsxs("div",{className:"flex space-x-2",children:[t.jsx("button",{onClick:j,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700",children:"清除所有"}),t.jsx("button",{onClick:w,className:"flex-1 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700",children:"重置统计"})]})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"预取统计"}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-md space-y-2",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"总数:"}),t.jsx("span",{className:"text-sm font-medium",children:r.total})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"成功:"}),t.jsx("span",{className:"text-sm font-medium text-green-600",children:r.success})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"失败:"}),t.jsx("span",{className:"text-sm font-medium text-red-600",children:r.error})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"已缓存:"}),t.jsx("span",{className:"text-sm font-medium text-blue-600",children:r.cached})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"平均加载时间:"}),t.jsxs("span",{className:"text-sm font-medium",children:[r.avgLoadTime,"ms"]})]})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"预取项列表"}),t.jsx("div",{className:"bg-gray-50 p-4 rounded-md max-h-80 overflow-y-auto",children:e.length===0?t.jsx("div",{className:"text-sm text-gray-500 text-center py-4",children:"暂无预取项"}):t.jsx("div",{className:"space-y-2",children:e.map((a,m)=>t.jsxs("div",{className:"p-3 bg-white rounded border",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsxs("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded",children:["#",m+1]}),t.jsx("span",{className:`text-xs px-2 py-1 rounded ${C(a.status)} ${N(a.status)}`,children:a.status})]}),t.jsx("button",{onClick:()=>v(a.url),disabled:a.status!=="success",className:"px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400",children:"获取数据"})]}),t.jsx("div",{className:"text-sm text-gray-700 mb-1 truncate",children:a.url}),t.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[t.jsx("span",{children:a.loadTime?`${a.loadTime}ms`:"-"}),t.jsx("span",{children:a.retryCount>0?`重试: ${a.retryCount}`:""}),t.jsx("span",{children:new Date(a.timestamp).toLocaleTimeString()})]}),a.error&&t.jsx("div",{className:"mt-2 text-xs text-red-600 bg-red-50 p-2 rounded",children:a.error.message})]},a.id))})})]})]})]})]})})},R=()=>{const i=[{title:"核心概念",items:["预取策略：立即、空闲、悬停、可见性、手动","缓存管理：数据过期、清理机制","性能优化：减少等待时间、提升用户体验","智能调度：并发控制、优先级管理"]},{title:"主要优势",items:["提升用户体验：减少页面加载等待时间","智能预测：基于用户行为预取可能需要的数据","资源优化：合理利用网络和浏览器空闲时间","灵活配置：支持多种预取策略和参数调整"]},{title:"适用场景",items:["单页应用的路由预加载","列表页面的详情数据预取","图片和媒体资源的预加载","API 数据的智能缓存"]},{title:"注意事项",items:["避免过度预取导致带宽浪费","考虑移动设备的网络限制","合理设置缓存时间和清理策略","监控预取效果和性能指标"]}];return t.jsx(k,{title:"请求预取 (Request Prefetch)",description:"学习如何实现智能的请求预取策略，提升用户体验和应用性能。",overview:i,examples:[{title:"预取策略演示",component:t.jsx(L,{}),description:"演示不同的预取策略：立即预取、空闲预取、悬停预取、可见性预取等。",observationPoints:["立即预取会在调用时立即执行请求","空闲预取会在浏览器空闲时执行","悬停预取在鼠标悬停指定时间后触发","可见性预取在元素进入视口时触发","统计信息实时显示预取的成功率和性能"],keyPoints:["支持多种预取策略满足不同场景需求","智能的缓存管理和过期处理","并发控制避免过多同时请求","详细的统计信息帮助性能分析"],commonTraps:["过度预取导致带宽浪费","缓存时间设置不当","没有考虑移动设备的网络限制","预取失败时缺少降级处理"],solutions:["根据用户行为和网络状况调整预取策略","设置合理的缓存时间和最大并发数","检测网络类型和速度进行自适应调整","实现重试机制和错误处理"],importantTips:["预取应该是渐进增强，不影响核心功能","监控预取命中率和性能指标","考虑用户的数据使用偏好设置"]}],tutorial:{concepts:["预取策略：根据不同场景选择合适的预取时机","缓存管理：实现数据的存储、过期和清理机制","性能监控：跟踪预取效果和资源使用情况","智能调度：控制并发数量和请求优先级"],steps:["定义预取配置接口，包括超时、重试、缓存时间等参数","实现预取管理器，支持多种预取策略","添加缓存机制，管理数据的存储和过期","实现并发控制，避免过多同时请求","添加统计功能，监控预取效果","集成到实际应用中，根据用户行为触发预取"],tips:["使用 IntersectionObserver API 实现可见性预取","利用 requestIdleCallback 在浏览器空闲时预取","实现指数退避的重试策略","考虑使用 Service Worker 进行更高级的缓存控制"]},interview:{questions:[{question:"什么是请求预取？有哪些常见的预取策略？",answer:"请求预取是在用户实际需要数据之前提前加载数据的技术。常见策略包括：1) 立即预取 - 在特定事件触发时立即执行；2) 空闲预取 - 在浏览器空闲时执行；3) 悬停预取 - 在用户悬停元素时触发；4) 可见性预取 - 在元素进入视口时触发；5) 手动预取 - 由开发者手动控制。"},{question:"如何实现智能的预取缓存管理？",answer:"智能缓存管理包括：1) 设置合理的缓存时间和过期时间；2) 实现 LRU 或其他缓存淘汰策略；3) 根据数据访问频率调整缓存优先级；4) 监控缓存命中率和内存使用；5) 在数据过期但未超出缓存时间时进行后台刷新；6) 提供手动清理和重置功能。"},{question:"预取策略如何避免性能问题？",answer:"避免性能问题的方法：1) 设置最大并发数限制；2) 根据网络状况调整预取频率；3) 实现请求优先级管理；4) 使用 AbortController 支持请求取消；5) 监控带宽使用和设备性能；6) 提供用户设置选项控制预取行为；7) 在移动设备上采用更保守的策略。"},{question:"如何衡量预取策略的效果？",answer:"效果衡量指标包括：1) 缓存命中率 - 预取数据被实际使用的比例；2) 响应时间改善 - 用户请求的平均响应时间减少；3) 带宽利用率 - 预取请求占总带宽的比例；4) 用户体验指标 - 页面加载时间、交互响应时间等；5) 错误率 - 预取请求的失败率；6) 资源使用 - 内存和存储空间占用。"}],keyPoints:["预取是性能优化的重要手段，但需要平衡收益和成本","不同场景需要选择合适的预取策略","缓存管理是预取系统的核心组件","性能监控对于优化预取策略至关重要","用户体验应该是预取策略的最终目标"]},bestPractices:{dos:["根据用户行为模式设计预取策略","实现渐进式的预取，从保守到激进","监控预取效果并持续优化","提供用户控制预取行为的选项","在移动设备上采用更节省流量的策略","实现完善的错误处理和重试机制"],donts:["不要过度预取导致带宽浪费","不要忽视移动设备的网络限制","不要让预取影响关键路径的性能","不要缓存敏感或个人数据","不要在网络条件差时继续激进预取"],patterns:["观察者模式：监听用户行为触发预取","策略模式：根据场景选择不同预取策略","缓存模式：实现多层缓存和过期管理","队列模式：管理预取请求的优先级和并发","适配器模式：适配不同的存储和网络接口"]}})};export{R as default};
