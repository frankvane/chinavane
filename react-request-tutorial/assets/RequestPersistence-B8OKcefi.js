var P=Object.defineProperty;var q=(c,e,t)=>e in c?P(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var m=(c,e,t)=>q(c,typeof e!="symbol"?e+"":e,t);import{r as o,j as s}from"./index-C7SuDyTR.js";import{C as E}from"./ComponentTemplate-BzrYXZsv.js";class j{constructor(){m(this,"storage",new Map)}get(e){return this.storage.get(e)}set(e,t){this.storage.set(e,t)}remove(e){this.storage.delete(e)}clear(){this.storage.clear()}keys(){return Array.from(this.storage.keys())}size(){return this.storage.size}}class O{constructor(e="app_"){m(this,"prefix");this.prefix=e}get(e){try{const t=localStorage.getItem(this.prefix+e);return t?JSON.parse(t):null}catch(t){return console.error("LocalStorage get error:",t),null}}set(e,t){try{localStorage.setItem(this.prefix+e,JSON.stringify(t))}catch(r){throw console.error("LocalStorage set error:",r),r}}remove(e){localStorage.removeItem(this.prefix+e)}clear(){this.keys().forEach(t=>this.remove(t))}keys(){const e=[];for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t);r&&r.startsWith(this.prefix)&&e.push(r.substring(this.prefix.length))}return e}size(){return this.keys().length}}class A{constructor(e="app_"){m(this,"prefix");this.prefix=e}get(e){try{const t=sessionStorage.getItem(this.prefix+e);return t?JSON.parse(t):null}catch(t){return console.error("SessionStorage get error:",t),null}}set(e,t){try{sessionStorage.setItem(this.prefix+e,JSON.stringify(t))}catch(r){throw console.error("SessionStorage set error:",r),r}}remove(e){sessionStorage.removeItem(this.prefix+e)}clear(){this.keys().forEach(t=>this.remove(t))}keys(){const e=[];for(let t=0;t<sessionStorage.length;t++){const r=sessionStorage.key(t);r&&r.startsWith(this.prefix)&&e.push(r.substring(this.prefix.length))}return e}size(){return this.keys().length}}class J{constructor(e="AppDB",t="data",r=1){m(this,"dbName");m(this,"storeName");m(this,"version");m(this,"db",null);this.dbName=e,this.storeName=t,this.version=r}async openDB(){return this.db?this.db:new Promise((e,t)=>{const r=indexedDB.open(this.dbName,this.version);r.onerror=()=>t(r.error),r.onsuccess=()=>{this.db=r.result,e(this.db)},r.onupgradeneeded=n=>{const l=n.target.result;l.objectStoreNames.contains(this.storeName)||l.createObjectStore(this.storeName)}})}async get(e){const t=await this.openDB();return new Promise((r,n)=>{const d=t.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);d.onerror=()=>n(d.error),d.onsuccess=()=>r(d.result||null)})}async set(e,t){const r=await this.openDB();return new Promise((n,l)=>{const g=r.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(t,e);g.onerror=()=>l(g.error),g.onsuccess=()=>n()})}async remove(e){const t=await this.openDB();return new Promise((r,n)=>{const d=t.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);d.onerror=()=>n(d.error),d.onsuccess=()=>r()})}async clear(){const e=await this.openDB();return new Promise((t,r)=>{const i=e.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();i.onerror=()=>r(i.error),i.onsuccess=()=>t()})}async keys(){const e=await this.openDB();return new Promise((t,r)=>{const i=e.transaction([this.storeName],"readonly").objectStore(this.storeName).getAllKeys();i.onerror=()=>r(i.error),i.onsuccess=()=>t(i.result)})}async size(){const e=await this.openDB();return new Promise((t,r)=>{const i=e.transaction([this.storeName],"readonly").objectStore(this.storeName).count();i.onerror=()=>r(i.error),i.onsuccess=()=>t(i.result)})}}class R{constructor(e){m(this,"config");m(this,"stats",{reads:0,writes:0,hits:0,misses:0,errors:0});this.config=e}async store(e,t,r){try{const n={data:this.serialize(t),timestamp:Date.now(),ttl:(r==null?void 0:r.ttl)||this.config.ttl,size:this.calculateSize(t),metadata:r==null?void 0:r.metadata};if(this.config.maxSize&&n.size>this.config.maxSize)throw new Error(`Data size (${n.size}) exceeds maximum allowed size (${this.config.maxSize})`);let l=n;this.config.encryption&&(l={...n,data:this.config.encryption.encrypt(JSON.stringify(n.data))}),await this.config.adapter.set(e,l),this.stats.writes++}catch(n){throw this.stats.errors++,n}}async retrieve(e){try{this.stats.reads++;const t=await this.config.adapter.get(e);if(!t)return this.stats.misses++,null;if(this.isExpired(t))return await this.remove(e),this.stats.misses++,null;let r=t.data;return this.config.encryption&&(r=JSON.parse(this.config.encryption.decrypt(r))),this.stats.hits++,this.deserialize(r)}catch(t){throw this.stats.errors++,t}}async remove(e){try{await this.config.adapter.remove(e)}catch(t){throw this.stats.errors++,t}}async clear(){try{await this.config.adapter.clear()}catch(e){throw this.stats.errors++,e}}async keys(){try{return await this.config.adapter.keys()}catch(e){throw this.stats.errors++,e}}async size(){try{return await this.config.adapter.size()}catch(e){throw this.stats.errors++,e}}async has(e){return await this.retrieve(e)!==null}async getItemInfo(e){try{return await this.config.adapter.get(e)||null}catch{return this.stats.errors++,null}}async cleanup(){try{const e=await this.keys();let t=0;for(const r of e){const n=await this.config.adapter.get(r);n&&this.isExpired(n)&&(await this.remove(r),t++)}return t}catch(e){throw this.stats.errors++,e}}getStats(){const e=this.stats.hits+this.stats.misses;return{...this.stats,hitRate:e>0?this.stats.hits/e*100:0}}resetStats(){this.stats={reads:0,writes:0,hits:0,misses:0,errors:0}}serialize(e){return this.config.serializer?this.config.serializer.serialize(e):e}deserialize(e){return this.config.serializer?this.config.serializer.deserialize(e):e}calculateSize(e){try{return JSON.stringify(e).length*2}catch{return 1e3}}isExpired(e){return e.ttl?Date.now()-e.timestamp>e.ttl:!1}}const M=()=>{const[c,e]=o.useState("localStorage"),[t,r]=o.useState(null),[n,l]=o.useState(""),[i,d]=o.useState(""),[g,v]=o.useState("60000"),[y,k]=o.useState(""),[b,w]=o.useState(null),[x,D]=o.useState({reads:0,writes:0,hits:0,misses:0,errors:0,hitRate:0}),[S,B]=o.useState([]),[p,f]=o.useState(!1),N=o.useCallback(a=>{switch(a){case"memory":return new j;case"localStorage":return new O("demo_");case"sessionStorage":return new A("demo_");case"indexedDB":return new J("DemoDB","demo");default:return new j}},[]);o.useEffect(()=>{const a=N(c),u=new R({adapter:a,ttl:6e4});r(u),h(u)},[c,N]);const h=o.useCallback(async a=>{try{D(a.getStats());const u=await a.keys();B(u)}catch(u){console.error("Update display failed:",u)}},[]),z=o.useCallback(async()=>{if(!(!t||!n||!i)){f(!0);try{let a;try{a=JSON.parse(i)}catch{a=i}await t.store(n,a,{ttl:parseInt(g)||void 0,metadata:{createdAt:new Date().toISOString()}}),await h(t),l(""),d("")}catch(a){alert(`存储失败: ${a instanceof Error?a.message:"未知错误"}`)}finally{f(!1)}}},[t,n,i,g,h]),C=o.useCallback(async()=>{if(!(!t||!y)){f(!0);try{const a=await t.retrieve(y);w(a),await h(t)}catch(a){alert(`获取失败: ${a instanceof Error?a.message:"未知错误"}`),w(null)}finally{f(!1)}}},[t,y,h]),L=o.useCallback(async a=>{if(t)try{await t.remove(a),await h(t)}catch(u){alert(`删除失败: ${u instanceof Error?u.message:"未知错误"}`)}},[t,h]),I=o.useCallback(async()=>{if(t)try{await t.clear(),await h(t),w(null)}catch(a){alert(`清空失败: ${a instanceof Error?a.message:"未知错误"}`)}},[t,h]),T=o.useCallback(async()=>{if(t)try{const a=await t.cleanup();alert(`清理了 ${a} 个过期项`),await h(t)}catch(a){alert(`清理失败: ${a instanceof Error?a.message:"未知错误"}`)}},[t,h]);return s.jsx("div",{className:"space-y-4",children:s.jsxs("div",{className:"bg-white p-6 rounded-lg border",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4",children:"基础持久化操作"}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"存储类型"}),s.jsxs("select",{value:c,onChange:a=>e(a.target.value),className:"w-full p-2 border border-gray-300 rounded-md",children:[s.jsx("option",{value:"memory",children:"内存存储"}),s.jsx("option",{value:"localStorage",children:"LocalStorage"}),s.jsx("option",{value:"sessionStorage",children:"SessionStorage"}),s.jsx("option",{value:"indexedDB",children:"IndexedDB"})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"存储数据"}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("input",{type:"text",value:n,onChange:a=>l(a.target.value),placeholder:"存储键",className:"w-full p-2 border border-gray-300 rounded-md"}),s.jsx("textarea",{value:i,onChange:a=>d(a.target.value),placeholder:"存储值（支持JSON格式）",className:"w-full p-2 border border-gray-300 rounded-md h-20"}),s.jsx("input",{type:"number",value:g,onChange:a=>v(a.target.value),placeholder:"TTL（毫秒）",className:"w-full p-2 border border-gray-300 rounded-md"}),s.jsx("button",{onClick:z,disabled:p||!n||!i,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400",children:p?"存储中...":"存储数据"})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"获取数据"}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("input",{type:"text",value:y,onChange:a=>k(a.target.value),placeholder:"要获取的键",className:"w-full p-2 border border-gray-300 rounded-md"}),s.jsx("button",{onClick:C,disabled:p||!y,className:"w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400",children:p?"获取中...":"获取数据"}),b!==null&&s.jsxs("div",{className:"p-3 bg-gray-100 rounded-md",children:[s.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:"获取结果:"}),s.jsx("pre",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:JSON.stringify(b,null,2)})]})]})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("h4",{className:"font-medium text-gray-900",children:"存储统计"}),s.jsxs("div",{className:"flex space-x-2",children:[s.jsx("button",{onClick:T,className:"px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700",children:"清理过期"}),s.jsx("button",{onClick:I,className:"px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700",children:"清空存储"})]})]}),s.jsxs("div",{className:"bg-gray-50 p-4 rounded-md space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"存储项数量:"}),s.jsx("span",{className:"text-sm font-medium",children:S.length})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"读取次数:"}),s.jsx("span",{className:"text-sm font-medium",children:x.reads})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"写入次数:"}),s.jsx("span",{className:"text-sm font-medium",children:x.writes})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"命中次数:"}),s.jsx("span",{className:"text-sm font-medium text-green-600",children:x.hits})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"未命中次数:"}),s.jsx("span",{className:"text-sm font-medium text-red-600",children:x.misses})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"错误次数:"}),s.jsx("span",{className:"text-sm font-medium text-orange-600",children:x.errors})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-sm text-gray-600",children:"命中率:"}),s.jsxs("span",{className:"text-sm font-medium",children:[x.hitRate.toFixed(2),"%"]})]})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"存储项列表"}),s.jsx("div",{className:"bg-gray-50 p-4 rounded-md max-h-64 overflow-y-auto",children:S.length===0?s.jsx("div",{className:"text-sm text-gray-500 text-center py-4",children:"暂无存储项"}):s.jsx("div",{className:"space-y-2",children:S.map(a=>s.jsxs("div",{className:"flex items-center justify-between p-2 bg-white rounded border",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"text-sm font-medium text-gray-900",children:a}),s.jsxs("div",{className:"text-xs text-gray-500",children:["存储类型: ",c]})]}),s.jsx("button",{onClick:()=>L(a),className:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700",children:"删除"})]},a))})})]})]})]})]})})};function W(){return s.jsx(E,{title:"请求持久化",description:"实现多种存储方式的请求数据持久化，支持内存、LocalStorage、SessionStorage和IndexedDB。",overview:[{title:"核心概念",items:["存储适配器：统一的存储接口，支持多种存储方式","数据序列化：自动处理复杂数据类型的序列化和反序列化","TTL管理：基于时间的数据过期机制","加密支持：可选的数据加密和解密功能"]},{title:"主要优势",items:["统一的存储接口，便于切换不同存储方式","自动处理数据序列化和反序列化","支持数据过期和自动清理机制","提供详细的统计信息和性能监控","可选的数据加密和压缩功能"]},{title:"适用场景",items:["用户偏好设置的本地存储","表单数据的临时保存","离线数据的缓存管理","会话状态的持久化","大量数据的本地存储"]},{title:"注意事项",items:["不同存储方式有不同的容量限制","敏感数据需要加密处理","注意浏览器兼容性问题","定期清理过期数据避免存储溢出","考虑用户隐私和数据安全"]}],examples:[{title:"基础持久化操作",component:s.jsx(M,{}),description:"演示不同存储方式的基本操作，包括存储、获取、删除和统计。",observationPoints:["切换不同存储类型时，观察数据的持久性差异","内存存储在页面刷新后数据会丢失","LocalStorage 数据在浏览器关闭后仍然保留","SessionStorage 数据在标签页关闭后清除","IndexedDB 支持大容量数据存储","观察统计信息中的命中率和错误次数"],keyPoints:["统一的存储接口便于管理不同存储方式","TTL 机制可以自动清理过期数据","统计信息有助于监控存储性能","支持 JSON 格式的复杂数据存储"],commonTraps:["忘记处理存储异常和容量限制","在客户端存储敏感信息","不考虑不同存储方式的特性差异","忽略数据过期和清理机制"],solutions:["实现完善的错误处理机制","对敏感数据进行加密处理","根据需求选择合适的存储方式","定期执行数据清理操作"],importantTips:["LocalStorage 适合长期存储用户偏好","SessionStorage 适合临时会话数据","IndexedDB 适合大容量结构化数据","内存存储适合临时缓存数据"]}],tutorial:{concepts:["持久化是保存应用状态和数据的重要手段","不同存储方式有不同的特点和适用场景","统一的存储接口便于切换和管理","TTL 机制可以自动管理数据生命周期","序列化处理复杂数据类型的存储"],steps:["选择合适的存储方式（内存、LocalStorage、SessionStorage、IndexedDB）","实现存储适配器接口，统一不同存储方式的操作","配置序列化和加密选项，处理复杂数据类型","实现数据的存储和获取，包括错误处理","添加 TTL 和清理机制，管理数据生命周期","实现统计功能，监控存储性能和使用情况"],tips:["根据数据特性和使用场景选择存储方式","注意存储容量和性能限制","实现适当的错误处理和降级机制","定期清理过期数据避免存储溢出","考虑数据安全和用户隐私保护"]},interview:{questions:[{question:"前端有哪些数据持久化方案？各有什么特点？",answer:"主要方案包括：1) Cookie：容量小(4KB)，会自动发送到服务器，适合存储少量认证信息；2) LocalStorage：容量大(5-10MB)，持久存储，适合用户偏好设置；3) SessionStorage：会话级存储，标签页关闭后清除，适合临时数据；4) IndexedDB：大容量NoSQL数据库，支持事务和索引，适合复杂数据；5) WebSQL：已废弃；6) Cache API：用于缓存网络请求。"},{question:"如何设计一个通用的前端存储管理器？",answer:"设计要点：1) 适配器模式：定义统一接口，支持多种存储方式；2) 序列化处理：自动处理复杂数据类型；3) TTL 管理：支持数据过期和自动清理；4) 错误处理：优雅处理存储异常和容量限制；5) 统计监控：提供性能指标和使用统计；6) 安全性：支持数据加密和压缩；7) 类型安全：使用 TypeScript 提供类型检查。"},{question:"LocalStorage 和 SessionStorage 的区别是什么？",answer:"主要区别：1) 生命周期：LocalStorage 持久存储直到手动清除，SessionStorage 在标签页关闭时清除；2) 作用域：LocalStorage 在同源的所有标签页间共享，SessionStorage 仅在当前标签页有效；3) 容量：通常都是 5-10MB；4) 用途：LocalStorage 适合长期设置，SessionStorage 适合会话数据。"},{question:"IndexedDB 相比其他存储方案有什么优势？",answer:"IndexedDB 优势：1) 大容量：通常可存储几百MB到几GB数据；2) 异步操作：不会阻塞主线程；3) 事务支持：保证数据一致性；4) 索引查询：支持复杂查询和排序；5) 结构化存储：可存储对象、文件等复杂数据；6) 版本管理：支持数据库结构升级。缺点是 API 复杂，需要封装使用。"}],keyPoints:["选择合适的存储方案很重要","注意数据安全和隐私保护","考虑存储容量和性能限制","实现统一的存储接口便于管理","添加数据过期和清理机制"]},bestPractices:{dos:["根据数据特性选择合适的存储方式","实现统一的存储接口便于管理","添加数据加密保护敏感信息","实现完善的错误处理机制","定期清理过期和无用数据","监控存储使用情况和性能"],donts:["不要在客户端存储敏感数据","不要忽略存储容量限制","不要忘记处理存储异常","不要在同步代码中使用 IndexedDB","不要存储过大的数据对象"],patterns:["适配器模式：统一不同存储方式的接口","策略模式：根据需求选择存储策略","装饰器模式：添加加密、压缩等功能","观察者模式：监听存储变化事件","工厂模式：创建不同类型的存储实例"]}})}export{W as default};
