var T=Object.defineProperty;var C=(r,t,s)=>t in r?T(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var q=(r,t,s)=>C(r,typeof t!="symbol"?t+"":t,s);import{r as g,j as e}from"./index-C7SuDyTR.js";import{C as G}from"./ComponentTemplate-BzrYXZsv.js";var n=(r=>(r[r.LOW=1]="LOW",r[r.NORMAL=2]="NORMAL",r[r.HIGH=3]="HIGH",r[r.URGENT=4]="URGENT",r))(n||{});class L{constructor(){q(this,"queue",[]);q(this,"running",new Map);q(this,"maxConcurrency",3);q(this,"taskIdCounter",0)}addRequest(t,s={},c=2){return new Promise((o,j)=>{const i=new AbortController,l={id:`task-${++this.taskIdCounter}`,url:t,options:{...s,signal:i.signal},priority:c,timestamp:Date.now(),resolve:o,reject:j,controller:i};this.insertTask(l),this.processQueue()})}insertTask(t){let s=this.queue.length;for(let c=0;c<this.queue.length;c++){const o=this.queue[c];if(t.priority>o.priority||t.priority===o.priority&&t.timestamp<o.timestamp){s=c;break}}this.queue.splice(s,0,t)}async processQueue(){for(;this.queue.length>0&&this.running.size<this.maxConcurrency;){const t=this.queue.shift();this.running.set(t.id,t),this.executeTask(t).finally(()=>{this.running.delete(t.id),setTimeout(()=>this.processQueue(),0)})}}async executeTask(t){try{const s=await fetch(t.url,t.options);t.resolve(s)}catch(s){t.reject(s)}}cancelByPriority(t){let s=0;this.queue=this.queue.filter(c=>c.priority===t?(c.controller.abort(),c.reject(new DOMException("Request canceled","AbortError")),s++,!1):!0);for(const[,c]of this.running.entries())c.priority===t&&(c.controller.abort(),s++);return s}getQueueStatus(){const t={4:0,3:0,2:0,1:0},s={...t};return this.queue.forEach(c=>{t[c.priority]++}),this.running.forEach(c=>{s[c.priority]++}),{queue:t,running:s,totalQueue:this.queue.length,totalRunning:this.running.size,maxConcurrency:this.maxConcurrency}}setMaxConcurrency(t){this.maxConcurrency=Math.max(1,t),this.processQueue()}clearQueue(){const t=this.queue.length;return this.queue.forEach(s=>{s.controller.abort(),s.reject(new DOMException("Request canceled","AbortError"))}),this.queue=[],t}}const u=new L,$=()=>{var x,m,R,E,v,N,b,f;const[r,t]=g.useState([]),[s,c]=g.useState({}),o=d=>{t(h=>[...h.slice(-9),`${new Date().toLocaleTimeString()}: ${d}`])},j=()=>{c(u.getQueueStatus())},i=async(d,h)=>{const y=n[d];o(`添加${h}请求 (优先级: ${y})`);try{await u.addRequest(`https://jsonplaceholder.typicode.com/posts/${Math.floor(Math.random()*100)+1}`,{method:"GET"},d),o(`${h}请求完成 (优先级: ${y})`)}catch(w){w.name==="AbortError"||w.message.includes("canceled")?o(`${h}请求被取消 (优先级: ${y})`):o(`${h}请求失败 (优先级: ${y})`)}j()},l=d=>{const h=n[d],y=u.cancelByPriority(d);o(`取消${h}优先级请求，共取消 ${y} 个`),j()};return g.useEffect(()=>{const d=setInterval(j,500);return()=>clearInterval(d)},[]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"添加请求"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>i(n.LOW,"低优先级"),className:"w-full px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600",children:"添加低优先级请求"}),e.jsx("button",{onClick:()=>i(n.NORMAL,"普通"),className:"w-full px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",children:"添加普通请求"}),e.jsx("button",{onClick:()=>i(n.HIGH,"高优先级"),className:"w-full px-3 py-1 bg-orange-500 text-white rounded hover:bg-orange-600",children:"添加高优先级请求"}),e.jsx("button",{onClick:()=>i(n.URGENT,"紧急"),className:"w-full px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600",children:"添加紧急请求"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"取消请求"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>l(n.LOW),className:"w-full px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700",children:"取消低优先级"}),e.jsx("button",{onClick:()=>l(n.NORMAL),className:"w-full px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700",children:"取消普通请求"}),e.jsx("button",{onClick:()=>l(n.HIGH),className:"w-full px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700",children:"取消高优先级"}),e.jsx("button",{onClick:()=>l(n.URGENT),className:"w-full px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700",children:"取消紧急请求"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded",children:[e.jsx("h4",{className:"font-medium mb-2",children:"队列状态"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("div",{children:["队列长度: ",s.totalQueue||0]}),e.jsxs("div",{children:["运行中: ",s.totalRunning||0]}),e.jsxs("div",{children:["最大并发: ",s.maxConcurrency||3]})]}),e.jsxs("div",{children:[e.jsxs("div",{children:["紧急: ",((x=s.queue)==null?void 0:x[n.URGENT])||0," + ",((m=s.running)==null?void 0:m[n.URGENT])||0]}),e.jsxs("div",{children:["高优先级: ",((R=s.queue)==null?void 0:R[n.HIGH])||0," + ",((E=s.running)==null?void 0:E[n.HIGH])||0]}),e.jsxs("div",{children:["普通: ",((v=s.queue)==null?void 0:v[n.NORMAL])||0," + ",((N=s.running)==null?void 0:N[n.NORMAL])||0]}),e.jsxs("div",{children:["低优先级: ",((b=s.queue)==null?void 0:b[n.LOW])||0," + ",((f=s.running)==null?void 0:f[n.LOW])||0]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded max-h-40 overflow-y-auto",children:[e.jsx("h4",{className:"font-medium mb-2",children:"请求日志"}),r.map((d,h)=>e.jsx("div",{className:"text-sm text-gray-700",children:d},h))]})]})},k=()=>{var v,N,b,f,d,h,y,w;const[r,t]=g.useState([]),[s,c]=g.useState({}),[o,j]=g.useState(3),i=a=>{t(p=>[...p.slice(-9),`${new Date().toLocaleTimeString()}: ${a}`])},l=()=>{c(u.getQueueStatus())},x=()=>{i("模拟用户操作：添加紧急请求"),Array.from({length:3},(a,p)=>u.addRequest(`https://jsonplaceholder.typicode.com/posts/${p+1}`,{method:"GET"},n.URGENT).then(()=>i(`用户操作请求 ${p+1} 完成`)).catch(()=>i(`用户操作请求 ${p+1} 失败`))),l()},m=()=>{i("模拟后台任务：添加低优先级请求"),Array.from({length:5},(a,p)=>u.addRequest(`https://jsonplaceholder.typicode.com/posts/${p+10}`,{method:"GET"},n.LOW).then(()=>i(`后台任务 ${p+1} 完成`)).catch(()=>i(`后台任务 ${p+1} 失败`))),l()},R=a=>{j(a),u.setMaxConcurrency(a),i(`调整并发数为: ${a}`),l()},E=()=>{const a=u.clearQueue();i(`清空队列，取消 ${a} 个请求`),l()};return g.useEffect(()=>{const a=setInterval(l,500);return()=>clearInterval(a)},[]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"场景模拟"}),e.jsx("button",{onClick:x,className:"w-full px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600",children:"用户操作 (紧急)"}),e.jsx("button",{onClick:m,className:"w-full px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600",children:"后台任务 (低优先级)"}),e.jsx("button",{onClick:E,className:"w-full px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700",children:"清空队列"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"并发控制"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["当前并发数: ",o]}),e.jsx("div",{className:"flex gap-1",children:[1,2,3,5].map(a=>e.jsx("button",{onClick:()=>R(a),className:`px-2 py-1 rounded text-sm ${o===a?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:a},a))})]})]})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded",children:[e.jsx("h4",{className:"font-medium mb-2",children:"队列状态"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("div",{children:["队列: ",s.totalQueue||0]}),e.jsxs("div",{children:["运行: ",s.totalRunning||0]})]}),e.jsxs("div",{children:[e.jsxs("div",{children:["紧急: ",((v=s.queue)==null?void 0:v[n.URGENT])||0," + ",((N=s.running)==null?void 0:N[n.URGENT])||0]}),e.jsxs("div",{children:["高: ",((b=s.queue)==null?void 0:b[n.HIGH])||0," + ",((f=s.running)==null?void 0:f[n.HIGH])||0]})]}),e.jsxs("div",{children:[e.jsxs("div",{children:["普通: ",((d=s.queue)==null?void 0:d[n.NORMAL])||0," + ",((h=s.running)==null?void 0:h[n.NORMAL])||0]}),e.jsxs("div",{children:["低: ",((y=s.queue)==null?void 0:y[n.LOW])||0," + ",((w=s.running)==null?void 0:w[n.LOW])||0]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded max-h-40 overflow-y-auto",children:[e.jsx("h4",{className:"font-medium mb-2",children:"操作日志"}),r.map((a,p)=>e.jsx("div",{className:"text-sm text-gray-700",children:a},p))]})]})},O=()=>{const[r,t]=g.useState([]);g.useState({});const s=x=>{t(m=>[...m.slice(-9),`${new Date().toLocaleTimeString()}: ${x}`])},c=()=>{},o=()=>{s("页面加载：关键资源优先"),u.addRequest("https://jsonplaceholder.typicode.com/users/1",{method:"GET"},n.URGENT).then(()=>s("用户信息加载完成 (紧急)")).catch(()=>s("用户信息加载失败")),u.addRequest("https://jsonplaceholder.typicode.com/posts/1",{method:"GET"},n.HIGH).then(()=>s("页面内容加载完成 (高)")).catch(()=>s("页面内容加载失败")),u.addRequest("https://jsonplaceholder.typicode.com/comments?postId=1",{method:"GET"},n.NORMAL).then(()=>s("评论加载完成 (普通)")).catch(()=>s("评论加载失败"))},j=()=>{s("用户交互：立即响应"),u.addRequest("https://jsonplaceholder.typicode.com/posts/2",{method:"GET"},n.URGENT).then(()=>s("用户点击响应完成 (紧急)")).catch(()=>s("用户点击响应失败"))},i=()=>{s("数据分析：后台处理"),Array.from({length:3},(x,m)=>u.addRequest(`https://jsonplaceholder.typicode.com/albums/${m+1}`,{method:"GET"},n.LOW).then(()=>s(`分析任务 ${m+1} 完成 (低)`)).catch(()=>s(`分析任务 ${m+1} 失败`)))},l=()=>{s("搜索请求：高优先级"),u.addRequest("https://jsonplaceholder.typicode.com/posts?q=search",{method:"GET"},n.HIGH).then(()=>s("搜索结果加载完成 (高)")).catch(()=>s("搜索请求失败"))};return g.useEffect(()=>{const x=setInterval(c,500);return()=>clearInterval(x)},[]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"页面场景"}),e.jsx("button",{onClick:o,className:"w-full px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",children:"页面加载"}),e.jsx("button",{onClick:j,className:"w-full px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600",children:"用户交互"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"后台场景"}),e.jsx("button",{onClick:l,className:"w-full px-3 py-1 bg-orange-500 text-white rounded hover:bg-orange-600",children:"搜索请求"}),e.jsx("button",{onClick:i,className:"w-full px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600",children:"数据分析"})]})]}),e.jsxs("div",{className:"bg-purple-50 p-3 rounded",children:[e.jsx("h4",{className:"font-medium mb-2",children:"优先级说明"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded"}),e.jsx("span",{children:"紧急：用户交互、关键资源"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded"}),e.jsx("span",{children:"高：搜索、页面内容"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded"}),e.jsx("span",{children:"普通：次要内容、评论"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-500 rounded"}),e.jsx("span",{children:"低：分析、统计、预加载"})]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded max-h-40 overflow-y-auto",children:[e.jsx("h4",{className:"font-medium mb-2",children:"场景日志"}),r.map((x,m)=>e.jsx("div",{className:"text-sm text-gray-700",children:x},m))]})]})},M=()=>{const r=[{title:"核心概念",items:["优先级队列：按优先级和时间顺序管理请求","动态调度：高优先级请求可以插队执行","并发控制：限制同时执行的请求数量","智能取消：可按优先级批量取消请求"]},{title:"优先级分类",items:["紧急 (URGENT)：用户交互、关键业务操作","高 (HIGH)：搜索、页面主要内容加载","普通 (NORMAL)：一般内容、次要功能","低 (LOW)：分析统计、预加载、后台任务"]},{title:"主要优势",items:["提升关键操作的响应速度","合理分配网络资源和带宽","改善用户感知性能","支持复杂业务场景的需求"]},{title:"适用场景",items:["页面加载时的资源优先级管理","用户交互的即时响应需求","后台任务与前台操作的协调","网络条件受限时的资源调度"]}];return e.jsx(G,{title:"请求优先级",description:"通过优先级调度机制，确保重要请求优先执行，提升用户体验",overview:r,examples:[{title:"基础优先级管理",component:e.jsx($,{}),description:"演示不同优先级请求的调度和管理",observationPoints:["高优先级请求会插队到队列前面","相同优先级按时间顺序执行","可以按优先级批量取消请求","队列状态实时显示各优先级的请求数量"],keyPoints:["优先级队列使用插入排序维护顺序","并发控制限制同时执行的请求数","取消操作只影响指定优先级的请求","状态监控提供详细的队列信息"],commonTraps:["优先级设置不合理导致饥饿问题","没有考虑请求的执行时间","并发数设置过高或过低"],solutions:["合理设计优先级分级策略","考虑请求的预估执行时间","根据网络条件动态调整并发数"],importantTips:["紧急请求会立即插队到队列最前面","低优先级请求可能会被延后执行","取消操作会影响队列中和运行中的请求"]},{title:"动态优先级调度",component:e.jsx(k,{}),description:"演示动态调整优先级和并发控制",observationPoints:["用户操作会添加紧急优先级请求","后台任务使用低优先级避免影响用户体验","并发数可以动态调整影响执行速度","清空队列会取消所有等待中的请求"],keyPoints:["用户操作应该使用最高优先级","后台任务使用低优先级避免阻塞","并发数影响整体执行效率","队列管理支持批量操作"],commonTraps:["所有请求都设置为高优先级","并发数设置不当影响性能","没有区分用户操作和后台任务"],solutions:["严格按业务重要性设置优先级","根据设备性能调整并发数","明确区分前台和后台操作"],importantTips:["用户操作的紧急请求会立即执行","后台任务不会影响用户交互的响应","并发数调整会立即影响队列处理速度"]},{title:"实际应用场景",component:e.jsx(O,{}),description:"演示真实业务场景中的优先级应用",observationPoints:["页面加载时关键资源优先执行","用户交互获得最高优先级响应","搜索请求使用高优先级保证体验","数据分析使用低优先级后台执行"],keyPoints:["页面加载的资源有明确的优先级划分","用户交互需要立即响应","搜索等核心功能使用高优先级","分析统计等后台任务使用低优先级"],commonTraps:["所有页面资源使用相同优先级","后台任务优先级设置过高","没有考虑用户感知的重要性"],solutions:["根据资源重要性分级处理","后台任务使用最低优先级","优先保证用户可感知的操作"],importantTips:["页面加载时用户信息和内容会优先加载","用户点击操作会立即得到响应","数据分析任务在后台静默执行"]}],tutorial:{concepts:["优先级是请求调度的核心依据","队列使用堆或排序数组维护优先级顺序","并发控制限制同时执行的请求数量","动态调度允许高优先级请求插队","取消机制支持按优先级批量操作"],steps:["定义优先级枚举和请求任务接口","实现优先级队列的插入和排序逻辑","添加并发控制和任务执行机制","实现按优先级的取消和状态查询","集成到实际业务场景中使用"],tips:["优先级分级不宜过多，4-5级足够","考虑请求的业务重要性而非技术实现","并发数应根据设备性能和网络条件调整","避免低优先级请求长期饥饿","提供队列状态监控便于调试和优化"]},interview:{questions:[{question:"如何实现请求的优先级调度？",answer:"通过维护一个优先级队列，使用堆或排序数组结构。新请求根据优先级和时间戳插入到正确位置，执行时从队列头部取出最高优先级的请求。结合并发控制限制同时执行的请求数量。"},{question:"如何避免低优先级请求饥饿？",answer:"可以采用老化机制，随时间推移提升等待时间长的请求优先级；或者保证低优先级请求的最小执行比例；还可以设置超时机制，超时的低优先级请求自动提升优先级。"},{question:"优先级如何与其他请求管理机制结合？",answer:"优先级可以与缓存、去重、分组等机制结合。例如：高优先级请求可以绕过缓存直接执行；相同优先级的重复请求可以去重；同一分组内的请求可以使用相同优先级。"},{question:"如何设计合理的优先级分级？",answer:"应该基于业务重要性而非技术实现。通常分为4-5级：紧急（用户交互）、高（核心功能）、普通（一般内容）、低（后台任务）。每级应有明确的使用场景和判断标准。"}],keyPoints:["优先级调度是提升用户体验的重要手段","队列数据结构是实现优先级调度的基础","并发控制与优先级调度需要协调配合","避免饥饿问题是优先级系统的关键考虑","优先级设计应该基于业务价值而非技术复杂度"]},bestPractices:{dos:["根据业务重要性合理设置优先级","为用户交互操作设置最高优先级","后台任务使用低优先级避免阻塞","提供队列状态监控和调试信息","考虑网络条件动态调整并发数","实现防饥饿机制保护低优先级请求"],donts:["不要所有请求都使用高优先级","不要忽略低优先级请求的饥饿问题","不要设置过多的优先级分级","不要忽略并发数对性能的影响","不要在优先级设计中混入技术因素"],patterns:["用户优先模式：用户操作始终获得最高优先级","分层加载模式：页面资源按重要性分级加载","后台静默模式：分析统计等任务使用最低优先级","动态调整模式：根据网络状况调整优先级策略","时间衰减模式：等待时间长的请求逐步提升优先级"]}})};export{M as default};
