const d=(()=>{const i=new Map;function s(c){let n=i.get(c);return n||(n={current:0,queue:[]},i.set(c,n)),n}async function f(c,n,u,e){const r=s(c);if(r.current<n){r.current+=1,u&&console.debug(`[ConcurrencyGate] acquire immediate: ${c} -> ${r.current}/${n}`);return}u&&console.debug(`[ConcurrencyGate] queued: ${c} size=${r.queue.length+1}`),await new Promise((o,t)=>{const a={resolve:()=>{a.timer&&clearTimeout(a.timer),r.current+=1,u&&console.debug(`[ConcurrencyGate] acquire from queue: ${c} -> ${r.current}/${n}`),o()},reject:t};e&&e>0&&(a.timer=setTimeout(()=>{const l=r.queue.indexOf(a);l>=0&&r.queue.splice(l,1),u&&console.debug(`[ConcurrencyGate] acquire timeout: ${c} after ${e}ms`),t==null||t(new Error(`acquire timeout for ${c}`))},e)),r.queue.push(a)})}function y(c,n,u){const e=s(c);e.current>0&&(e.current-=1),u&&console.debug(`[ConcurrencyGate] release: ${c} -> ${e.current}/${n}`);const r=e.queue.shift();r&&r.resolve()}return{acquire:f,release:y}})();function g(i,s){if(s==="global")return"__global__";try{return`host:${new URL(i,typeof window<"u"?window.location.origin:"http://localhost").hostname}`}catch{return"__global__"}}function h(i={}){const{maxConcurrent:s=4,scope:f="global",adaptive:y=!0,acquireTimeoutMs:c=8e3,debug:n=!1}=i;function u(e,r){var a,l;if(!y)return e;const o=(a=r.networkInfo)==null?void 0:a.effectiveType;if((l=r.networkInfo)==null?void 0:l.saveData)return 1;switch(o){case"slow-2g":case"2g":return 1;case"3g":return Math.max(1,Math.floor(e/2));case"4g":default:return e}}return{name:"concurrency-control",version:"1.0.0",config:i,hooks:{onLoad:async e=>{var t;const r=g(e.src,f),o=u(s,e);try{await d.acquire(r,o,n,c)}catch(a){n&&console.debug("[ConcurrencyControl] proceed without permit due to:",a);return}try{(t=e.sharedData)==null||t.set("cc:key",r)}catch{}},onLoadSuccess:e=>{var t;const r=((t=e.sharedData)==null?void 0:t.get("cc:key"))||g(e.src,f),o=u(s,e);d.release(r,o,n)},onLoadError:e=>{var t;const r=((t=e.sharedData)==null?void 0:t.get("cc:key"))||g(e.src,f),o=u(s,e);return d.release(r,o,n),!0},onUnmount:e=>{var o,t;const r=(o=e.sharedData)==null?void 0:o.get("cc:key");if(typeof r=="string"){const a=u(s,e);d.release(r,a,n);try{(t=e.sharedData)==null||t.delete("cc:key")}catch{}}}}}}export{h as c};
