var J=Object.defineProperty;var q=(n,e,t)=>e in n?J(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var m=(n,e,t)=>q(n,typeof e!="symbol"?e+"":e,t);import{r as a,j as P}from"./index-B9PC2ohi.js";const w=class w{constructor(){m(this,"observers",new Map);m(this,"elementToKey",new Map);m(this,"observerCallbacks",new Map);m(this,"observerStats",new Map);m(this,"totalCallbackExecutions",0);m(this,"debugMode",!1);m(this,"cleanupTimer");this.startAutoCleanup()}static getInstance(){return w.instance||(w.instance=new w),w.instance}setDebugMode(e){this.debugMode=e,e&&(console.log("[ObserverPool] Debug mode enabled"),console.log("[ObserverPool] Current stats:",this.getStats()))}startAutoCleanup(){typeof window>"u"||(this.cleanupTimer=setInterval(()=>{const e=Date.now(),t=6e4;this.observerStats.forEach((r,o)=>{if(e-r.lastUsedAt>t&&r.elementCount===0){const s=this.observers.get(o);s&&(s.disconnect(),this.observers.delete(o),this.observerCallbacks.delete(o),this.observerStats.delete(o),this.debugMode&&console.log(`[ObserverPool] Auto-cleaned idle observer: ${o}`))}})},6e4))}stopAutoCleanup(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=void 0)}getConfigKey(e){const{root:t,rootMargin:r="0px",threshold:o=0}=e,s=t?`root-${t.tagName}-${t.className}`:"root-null",i=Array.isArray(o)?o.join(","):String(o);return`${s}|${r}|${i}`}observe(e,t,r={},o=!1){const s=this.getConfigKey(r),i=Date.now();if(!this.observers.has(s)){const y=new IntersectionObserver(d=>{d.forEach(c=>{const D=this.observerCallbacks.get(s);D&&D.forEach(p=>{if(p.element===c.target){this.totalCallbackExecutions++;const O=this.observerStats.get(s);O&&(O.totalCallbacks++,O.lastUsedAt=Date.now()),p.callback(c.isIntersecting),p.unobserveOnVisible&&c.isIntersecting&&this.unobserve(c.target)}})})},{root:r.root||null,rootMargin:r.rootMargin||"0px",threshold:r.threshold??0});this.observers.set(s,y),this.observerCallbacks.set(s,new Set),this.observerStats.set(s,{key:s,elementCount:0,createdAt:i,lastUsedAt:i,totalCallbacks:0}),this.debugMode&&console.log(`[ObserverPool] Created new observer for config: ${s}`)}const h=this.observers.get(s),v=this.observerCallbacks.get(s),g={element:e,callback:t,unobserveOnVisible:o,addedAt:i};v.add(g),this.elementToKey.set(e,s);const b=this.observerStats.get(s);return b&&(b.elementCount++,b.lastUsedAt=i),h.observe(e),this.debugMode&&console.log(`[ObserverPool] Observing element, total: ${this.elementToKey.size}`),()=>this.unobserve(e)}unobserve(e){const t=this.elementToKey.get(e);if(!t)return;const r=this.observers.get(t),o=this.observerCallbacks.get(t);if(r&&o){r.unobserve(e);const s=Array.from(o).find(h=>h.element===e);s&&o.delete(s),this.elementToKey.delete(e);const i=this.observerStats.get(t);i&&(i.elementCount--,i.lastUsedAt=Date.now()),o.size===0&&this.debugMode&&console.log(`[ObserverPool] Observer ${t} has no elements (will auto-clean later)`)}}disconnectAll(){this.observers.forEach(e=>e.disconnect()),this.observers.clear(),this.observerCallbacks.clear(),this.elementToKey.clear(),this.observerStats.clear(),this.stopAutoCleanup(),this.debugMode&&console.log("[ObserverPool] Disconnected all observers")}getObserverCount(){return this.observers.size}getElementCount(){return this.elementToKey.size}getStats(){const e=this.observers.size,t=this.elementToKey.size,r=e>0?t/e:0,o=Date.now();let s,i,h;this.observerStats.forEach(d=>{const c=o-d.createdAt;(!s||c>s.age)&&(s={key:d.key,age:c}),(!i||c<i.age)&&(i={key:d.key,age:c}),(!h||d.elementCount>h.elementCount)&&(h={key:d.key,elementCount:d.elementCount})});const b=e*1024+t*100,y=b>1024*1024?`${(b/(1024*1024)).toFixed(2)} MB`:`${(b/1024).toFixed(2)} KB`;return{observerCount:e,elementCount:t,averageElementsPerObserver:Math.round(r*100)/100,oldestObserver:s,newestObserver:i,mostUsedObserver:h,totalCallbackExecutions:this.totalCallbackExecutions,memoryEstimate:y}}getObserverDetails(){return Array.from(this.observerStats.values())}cleanup(){let e=0;return this.observerCallbacks.forEach((t,r)=>{if(t.size===0){const o=this.observers.get(r);o&&(o.disconnect(),this.observers.delete(r),this.observerCallbacks.delete(r),this.observerStats.delete(r),e++)}}),this.debugMode&&console.log(`[ObserverPool] Manual cleanup: removed ${e} idle observers`),e}resetStats(){this.totalCallbackExecutions=0,this.observerStats.forEach(e=>{e.totalCallbacks=0}),this.debugMode&&console.log("[ObserverPool] Stats reset")}};m(w,"instance");let z=w;const $=z.getInstance(),G=(n,e,t,r)=>$.observe(n,e,t,r),se=()=>$.getStats(),oe=n=>$.setDebugMode(n),ne=()=>$.getObserverDetails();class Q{constructor(e,t={}){m(this,"id");m(this,"config");m(this,"metrics");m(this,"startTime");m(this,"endTime");this.id=e,this.config={enabled:t.enabled??!0,collectVitals:t.collectVitals??!0,enableDebug:t.enableDebug??!1,retentionTime:t.retentionTime??5*60*1e3},this.metrics={marks:{},measures:{},custom:{}},this.startTime=this.now(),this.config.collectVitals&&this.collectWebVitals(),this.config.enableDebug&&console.debug(`[PerformanceMonitor] Created: ${this.id}`)}now(){return performance.now()}mark(e){if(!this.config.enabled)return;const t=this.now();if(this.metrics.marks[e]=t,typeof performance<"u"&&performance.mark)try{performance.mark(`${this.id}:${e}`)}catch{}this.config.enableDebug&&console.debug(`[PerformanceMonitor] Mark: ${e} @ ${t.toFixed(2)}ms`)}measure(e,t,r){if(!this.config.enabled)return;const o=this.metrics.marks[t];if(o===void 0){console.warn(`[PerformanceMonitor] Start mark not found: ${t}`);return}const s=r?this.metrics.marks[r]:this.now();if(s===void 0){console.warn(`[PerformanceMonitor] End mark not found: ${r}`);return}const i=s-o;if(this.metrics.measures[e]=i,typeof performance<"u"&&performance.measure)try{performance.measure(`${this.id}:${e}`,`${this.id}:${t}`,r?`${this.id}:${r}`:void 0)}catch{}return this.config.enableDebug&&console.debug(`[PerformanceMonitor] Measure: ${e} = ${i.toFixed(2)}ms`),i}setCustomMetric(e,t){this.config.enabled&&(this.metrics.custom[e]=t)}collectWebVitals(){if(!(typeof performance>"u")){if(this.metrics.vitals={},performance.timing){const e=performance.timing,t=e.navigationStart;e.responseStart&&(this.metrics.vitals.ttfb=e.responseStart-t)}if(typeof PerformanceObserver<"u")try{new PerformanceObserver(r=>{const s=r.getEntries().find(i=>i.name==="first-contentful-paint");s&&this.metrics.vitals&&(this.metrics.vitals.fcp=s.startTime)}).observe({entryTypes:["paint"]}),new PerformanceObserver(r=>{const o=r.getEntries(),s=o[o.length-1];s&&this.metrics.vitals&&(this.metrics.vitals.lcp=s.startTime)}).observe({entryTypes:["largest-contentful-paint"]})}catch{}}}end(){this.endTime||(this.endTime=this.now(),this.mark("end"),this.config.enableDebug&&console.debug(`[PerformanceMonitor] Ended: ${this.id}`))}analyzeCriticalPath(){const e=this.metrics.marks,t={};return e.mount!==void 0&&e["load-start"]!==void 0&&(t.discoveryDelay=e["load-start"]-e.mount),e["load-start"]!==void 0&&e["load-end"]!==void 0&&(t.loadDelay=e["load-end"]-e["load-start"]),e["load-end"]!==void 0&&e["render-end"]!==void 0&&(t.renderDelay=e["render-end"]-e["load-end"]),Object.keys(t).length>0?t:void 0}generateRecommendations(){var r;const e=[],t=this.analyzeCriticalPath();return t!=null&&t.discoveryDelay&&t.discoveryDelay>100&&e.push(`发现延迟较高 (${t.discoveryDelay.toFixed(0)}ms)，考虑使用 preload 或提前触发加载`),t!=null&&t.loadDelay&&t.loadDelay>2e3&&e.push(`加载延迟较高 (${t.loadDelay.toFixed(0)}ms)，考虑优化图片大小或使用 CDN`),t!=null&&t.renderDelay&&t.renderDelay>50&&e.push(`渲染延迟较高 (${t.renderDelay.toFixed(0)}ms)，考虑优化渲染逻辑`),(r=this.metrics.vitals)!=null&&r.lcp&&this.metrics.vitals.lcp>2500&&e.push(`LCP 较慢 (${this.metrics.vitals.lcp.toFixed(0)}ms)，建议优化首屏图片加载`),e}getReport(){const e=this.endTime?this.endTime-this.startTime:this.now()-this.startTime;return{id:this.id,startTime:this.startTime,endTime:this.endTime,duration:e,metrics:this.metrics,criticalPath:this.analyzeCriticalPath(),recommendations:this.generateRecommendations()}}dispose(){if(typeof performance<"u")try{performance.getEntriesByType("mark").forEach(r=>{r.name.startsWith(`${this.id}:`)&&performance.clearMarks(r.name)}),performance.getEntriesByType("measure").forEach(r=>{r.name.startsWith(`${this.id}:`)&&performance.clearMeasures(r.name)})}catch{}this.config.enableDebug&&console.debug(`[PerformanceMonitor] Disposed: ${this.id}`)}}function X(n,e){return new Q(n,e)}function Y(n,e){switch(e.type){case"LOAD_START":return{status:"loading",displaySrc:e.payload.src,error:null};case"LOAD_SUCCESS":return{...n,status:"loaded",error:null};case"LOAD_ERROR":return{...n,status:"error",error:e.payload.error};case"RESET":return{status:"idle",displaySrc:null,error:null};default:return n}}function Z(n,e){const{root:t,rootMargin:r="0px",threshold:o=0,unobserveOnVisible:s=!0}=e||{},[i,h]=a.useState(!1),v=a.useRef({root:t,rootMargin:r,threshold:o,unobserveOnVisible:s});a.useEffect(()=>{v.current={root:t,rootMargin:r,threshold:o,unobserveOnVisible:s}});const g=a.useMemo(()=>JSON.stringify({rootMargin:r,threshold:o,unobserveOnVisible:s}),[r,o,s]);return a.useEffect(()=>{const b=n.current;if(!b)return;const y=v.current,d=G(b,c=>{h(c)},{root:y.root||null,rootMargin:y.rootMargin,threshold:y.threshold},y.unobserveOnVisible);return()=>{d()}},[g]),{inView:i}}const ee=a.forwardRef((n,e)=>{const{src:t,alt:r="",root:o,rootMargin:s,threshold:i,unobserveOnVisible:h,loading:v="lazy",isLCP:g=!1,fetchPriority:b="auto",enablePerformanceMonitor:y=!1,onBeforeLoad:d,onLoadStart:c,onLoadSuccess:D,onLoadError:p,onEnterViewport:O,onLeaveViewport:R,children:F,containerStyle:L,containerClassName:N,imageStyle:U,imageClassName:W}=n,K=a.useRef(null),B=a.useRef(null),M=a.useRef(null),u=a.useRef(null);a.useEffect(()=>(y&&!u.current&&(u.current=X(`lazy-image-${t}`,{enabled:!0,collectVitals:!1,enableDebug:!1}),u.current.mark("mount")),()=>{u.current&&(u.current.end(),u.current.dispose(),u.current=null)}),[y,t]);const[f,T]=a.useReducer(Y,{status:"idle",displaySrc:null,error:null}),V=a.useMemo(()=>!(g||v==="eager"),[g,v]),{inView:S}=Z(K,{root:o,rootMargin:s,threshold:i,unobserveOnVisible:h}),H=a.useMemo(()=>g?"eager":v==="auto"?"lazy":v,[g,v]),j=a.useMemo(()=>g?"high":b,[g,b]),x=a.useRef(!1);a.useEffect(()=>{var l,C;S&&!x.current?((l=u.current)==null||l.mark("enter-viewport"),O==null||O()):!S&&x.current&&((C=u.current)==null||C.mark("leave-viewport"),R==null||R()),x.current=S},[S,O,R]);const k=a.useCallback(async()=>{var C;if(f.status==="loading"||f.status==="loaded")return;(C=u.current)==null||C.mark("load-start"),M.current&&M.current.abort(),M.current=new AbortController;const l=M.current;c==null||c();try{const E=await Promise.resolve(d==null?void 0:d());if(l.signal.aborted)return;T({type:"LOAD_START",payload:{src:E||t}})}catch(E){if(l.signal.aborted)return;const I=E instanceof Error?E:new Error(String(E));T({type:"LOAD_ERROR",payload:{error:I}}),p==null||p(I)}},[t,d,c,p,f.status]);a.useEffect(()=>{V?S&&k():k()},[S,k,V]),a.useEffect(()=>()=>{M.current&&(M.current.abort(),M.current=null)},[]);const A=a.useCallback(()=>{T({type:"RESET"})},[]);a.useImperativeHandle(e,()=>({reload:()=>{A(),S&&k()},reset:()=>{A()},getState:()=>({isIdle:f.status==="idle",isLoading:f.status==="loading",isLoaded:f.status==="loaded",isError:f.status==="error"}),getPerformanceReport:()=>{var l;return((l=u.current)==null?void 0:l.getReport())||null}}),[S,k,f.status,A]);const _=a.useMemo(()=>({position:"relative",width:"100%",height:"100%",overflow:"hidden",background:f.status==="error"?"#fee":"#f5f5f5",display:"flex",alignItems:"center",justifyContent:"center",...L}),[L,f.status]);return P.jsxs("div",{ref:l=>{K.current=l,n.containerRefExternal&&(n.containerRefExternal.current=l)},className:N,style:_,children:[f.status==="loading"&&P.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",zIndex:2},children:P.jsx("span",{style:{color:"#999",fontSize:12},children:"Loading..."})}),f.displaySrc&&P.jsx("img",{ref:l=>{B.current=l,n.imageRefExternal&&(n.imageRefExternal.current=l)},src:f.displaySrc,alt:r,loading:H,...j!=="auto"&&{fetchpriority:j},crossOrigin:n.crossOrigin??void 0,onLoad:()=>{var l,C,E;(l=u.current)==null||l.mark("load-end"),(C=u.current)==null||C.measure("load-duration","load-start","load-end"),(E=u.current)==null||E.measure("total-duration","mount","load-end"),T({type:"LOAD_SUCCESS"}),D==null||D(f.displaySrc||void 0)},onError:()=>{var C,E;(C=u.current)==null||C.mark("load-error"),(E=u.current)==null||E.measure("error-duration","load-start","load-error");const l=new Error("Image load error");T({type:"LOAD_ERROR",payload:{error:l}}),p==null||p(l)},style:{width:"100%",height:"100%",objectFit:"cover",opacity:f.status==="loaded"?1:0,transition:"opacity 180ms ease",...U},className:W}),F]})});ee.displayName="LazyLoadImageCore";export{ee as L,ne as a,se as g,oe as s};
